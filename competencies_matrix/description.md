Вот детализированное описание нового модуля `competencies_matrix` для разработчика, который присоединяется к проекту. Оно учитывает предоставленный код, структуру существующего бэкенда "Карты Дисциплин", контекст встречи с руководителем и краткое описание, но избегает прямого копирования кода, делая на него ссылки.

---

# Руководство для разработчика: Модуль `competencies_matrix`

**Версия документа:** 1.0
**Дата:** [Текущая дата]

## 1. Введение и Цель Модуля

Привет! Этот документ описывает новый модуль `competencies_matrix`, который должен стать  ключевым компонентом для расширения функционала веб-приложения "Академический Прогресс".

**Основная цель** этого модуля — предоставить инструменты для **создания, управления и визуализации матриц распределения компетенций для образовательных программ (ОП)** Московского Политеха. Важно понимать, что фокус смещен с *общего учета успеваемости* (который частично реализован в существующем модуле `cabinet` - "Академический Прогресс") на **детализированную работу с компетенциями и, что критически важно, с Индикаторами их Достижения (ИДК)** в соответствии с требованиями ФГОС ВО и Профессиональных Стандартов (ПС).

**Ключевые задачи, решаемые модулем:**

1.  **Централизация данных:** Хранение информации об ОП, связанных ФГОС, выбранных ПС, компетенциях (УК, ОПК, ПК) и их ИДК.
2.  **Работа с ИДК:** Предоставление интерфейсов для управления (создание, редактирование) ИДК, включая ИДК для Профессиональных Компетенций (ПК), формируемых на основе ПС.
3.  **Формирование Матрицы:** Реализация механизма установления и верификации связей между **Дисциплинами** (из АУП) и **ИДК**.
4.  **Интеграция:** Взаимодействие с существующими данными ("Карты Дисциплин", ЛК) и использование NLP для автоматизации (в перспективе).

Этот модуль является **самостоятельной логической единицей**, но **тесно интегрирован** в существующий бэкенд "Карты Дисциплин".

## 2. Архитектурное Размещение

Модуль `competencies_matrix` реализован как **Flask Blueprint** (`competencies_matrix_bp`), зарегистрированный в основном приложении Flask (`app.py`).

**Расположение в структуре проекта:**

```
maps_backend/
├── ... (другие модули: administration, auth, cabinet, maps) ...
├── competencies_matrix/   # <<<--- НАШ МОДУЛЬ
│   ├── __init__.py        # Регистрация Blueprint
│   ├── routes.py          # API эндпоинты
│   ├── models.py          # Модели БД (НОВЫЕ таблицы)
│   ├── logic.py           # Бизнес-логика
│   ├── parsers.py         # Логика парсинга ПС
│   ├── schemas.py         # (Опц.) Схемы валидации/сериализации
│   └── utils.py           # Вспомогательные функции
├── ... (общие файлы: app.py, config.py, migrations) ...
```

**Преимущества такого подхода:**

*   **Изоляция кода:** Логика, связанная с компетенциями и матрицами, находится в одном месте.
*   **Переиспользование:** Мы используем **единую базу данных MySQL**, общие модели из `maps.models` (например, `AupData`, `SprDiscipline`, `TblAup`, `db`), общую конфигурацию (`config.py`) и модуль аутентификации (`auth`).
*   **Масштабируемость:** Модуль можно развивать независимо от других частей приложения.

**Важно:** Все новые таблицы базы данных, специфичные для этого функционала, определяются в `competencies_matrix/models.py`. Миграции для них будут создаваться с помощью Alembic в общей папке `migrations/`.

## 3. Структура Модуля `competencies_matrix`

*   **`__init__.py`:** (См. [код `competencies_matrix/__init__.py`](#1-competencies_matrix__init__py-регистрация-blueprint))
    *   Создает экземпляр `Blueprint` с префиксом `/api/competencies`. Все API-запросы к этому модулю будут начинаться с этого пути.
    *   Импортирует `routes.py` для регистрации маршрутов.
*   **`routes.py`:** (См. [код `competencies_matrix/routes.py`](#4-competencies_matrixroutespy-пример-api-эндпоинта))
    *   Определяет API эндпоинты (URL-адреса и методы HTTP: GET, POST, PATCH, DELETE).
    *   Принимает HTTP-запросы, извлекает данные (из URL, тела запроса, query-параметров).
    *   **Делегирует обработку** соответствующим функциям в `logic.py`.
    *   Использует декораторы из `auth.logic` для **проверки аутентификации и прав доступа**.
    *   Формирует и возвращает HTTP-ответы (обычно в формате JSON).
*   **`models.py`:** (См. [код `competencies_matrix/models.py`](#3-competencies_matrixmodelspy-модели-данных))
    *   Определяет SQLAlchemy модели для **НОВЫХ** таблиц базы данных, необходимых для хранения:
        *   Образовательных программ (`EducationalProgram`)
        *   ФГОС ВО (`FgosVo`)
        *   Профессиональных стандартов (`ProfStandard`) и их структуры (`GeneralizedLaborFunction`, `LaborFunction`, `LaborAction`, `RequiredSkill`, `RequiredKnowledge`)
        *   Типов компетенций (`CompetencyType`)
        *   Компетенций (`Competency` - УК, ОПК, ПК)
        *   **Индикаторов Достижения Компетенций (`Indicator` - ИУК, ИОПК, ИПК)**
        *   Связей между сущностями (ассоциативные таблицы: `FgosRecommendedPs`, `EducationalProgramPs`, `EducationalProgramAup`, `IndicatorPsLink`)
        *   **Матрицы компетенций (`CompetencyMatrix`)** - хранит связи "Дисциплина(АУП)-ИДК".
        *   (Опционально) Уровней освоения и дескрипторов (`MasteryLevel`, `IndicatorMasteryDescriptor`).
    *   Модели используют `db` из `maps.models` и `SerializerMixin` для базовой сериализации. **Важно:** Настроить `serialize_rules` для предотвращения циклических ссылок при сериализации связанных объектов.
*   **`logic.py`:** (См. [код `competencies_matrix/logic.py`](#5-competencies_matrixlogicpy-бизнес-логика))
    *   Содержит основную бизнес-логику модуля.
    *   Функции здесь **вызываются из `routes.py`**.
    *   Взаимодействует с моделями (`models.py` и `maps.models`) для чтения/записи данных в БД.
    *   Вызывает функции из `parsers.py` для обработки данных ПС.
    *   (В перспективе) Взаимодействует с NLP-модулем для получения рекомендаций.
    *   Реализует сложную логику: сборку данных для матрицы, проверку прав (если не вынесено в декораторы), обработку ошибок.
*   **`parsers.py`:** (См. [код `profstandard-lean.py`](#7-competencies_matrixparserspy-логика-парсинга))
    *   Отвечает за **парсинг и очистку** данных Профессиональных Стандартов (ПС) из исходных форматов (HTML, возможно Markdown).
    *   **Задача:** Преобразовать "сырой" ПС в **структурированные данные** (объекты/словари), соответствующие моделям в `models.py` (ПС, ОТФ, ТФ, действия, знания, умения), а также получить очищенный текстовый контент (Markdown) для хранения в `ProfStandard.parsed_content`.
    *   Использует библиотеки вроде `BeautifulSoup`, `lxml`, `pandas`, `markdownify`.
    *   Логика из скрипта `profstandard-lean.py` должна быть адаптирована и интегрирована сюда.
*   **`schemas.py` (Опционально):**
    *   Рекомендуется использовать Pydantic или Marshmallow для определения схем данных.
    *   **Назначение:**
        *   **Валидация** данных, поступающих в API-запросах (тело POST/PATCH).
        *   **Сериализация** данных, возвращаемых API (более гибкая, чем `SerializerMixin`).
*   **`utils.py`:**
    *   Содержит вспомогательные функции, утилиты, константы, специфичные для модуля `competencies_matrix`.

## 4. Ключевые Сущности и Поток Данных

Система оперирует следующими основными понятиями:

1.  **Образовательная Программа (ОП)** (`EducationalProgram`): Точка входа. Определяет контекст (ФГОС, набор ПС, АУП).
2.  **ФГОС ВО** (`FgosVo`): Источник УК, ОПК и их ИДК (ИУК, ИОПК). Содержит список *рекомендованных* ПС.
3.  **Профессиональный Стандарт (ПС)** (`ProfStandard`): Источник для формирования ПК и ИПК. Содержит иерархию: ОТФ -> ТФ -> Действия, Знания, Умения. Пользователь *выбирает* ПС для ОП из рекомендованных + добавляет свои.
4.  **Компетенция** (`Competency`): УК, ОПК (берутся из ФГОС) или ПК (формируется пользователем на основе ТФ из ПС).
5.  **Индикатор Достижения Компетенции (ИДК)** (`Indicator`): **Ключевая сущность.** Конкретизирует компетенцию. ИУК/ИОПК берутся из ФГОС/Распоряжения. ИПК формулируются пользователем на основе действий/знаний/умений из ПС. **Все ИДК хранятся единообразно.**
6.  **Академический Учебный План (АУП)** (`TblAup` из `maps.models`): Определяет список дисциплин по семестрам. Данные берутся из "Карт Дисциплин".
7.  **Дисциплина в АУП** (`AupData` из `maps.models`): Конкретная строка в АУП, связывающая дисциплину (`SprDiscipline`) с семестром, часами, ЗЕТ и т.д. **Именно `AupData.id` используется для привязки в матрице.**
8.  **Матрица Компетенций** (`CompetencyMatrix`): Таблица связей, показывающая, какой **ИДК** (`indicator_id`) формируется какой **Дисциплиной в рамках АУП** (`aup_data_id`).

**Основной поток данных при формировании матрицы:**

1.  Пользователь выбирает ОП.
2.  Система (`logic.py`) запрашивает:
    *   Данные ОП, связанный ФГОС, выбранные/рекомендованные ПС (из `competencies_matrix/models`).
    *   Список АУП, связанных с ОП (из `competencies_matrix.EducationalProgramAup`).
    *   Пользователь выбирает конкретный АУП.
    *   Список дисциплин для выбранного АУП (из `maps.models.AupData`).
3.  Система отображает УК/ОПК/ИУК/ИОПК из ФГОС.
4.  Пользователь управляет списком ПС для ОП.
5.  Пользователь формирует ПК и ИПК на основе выбранных ПС (ТФ -> ПК, Действия/Знания/Умения -> ИПК). *Здесь может подключаться `parsers.py` для отображения структуры ПС и NLP для помощи.*
6.  Система (`logic.py`) получает полный список дисциплин (AupData) и ИДК (всех типов) для ОП/АУП.
7.  (Опционально) `logic.py` запрашивает у NLP-модуля предложения по связям "Дисциплина ↔ ИДК".
8.  `logic.py` запрашивает существующие связи из `CompetencyMatrix`.
9.  Система (`routes.py` -> Frontend) отображает матрицу с существующими связями и предложениями.
10. Пользователь редактирует/верифицирует связи.
11. Система (`routes.py` -> `logic.py` -> `models.py`) сохраняет итоговые связи в `CompetencyMatrix`.

## 5. Интеграция с Другими Модулями/Системами

*   **`maps` (Карты Дисциплин):**
    *   **Чтение:** Необходимо получать данные об АУП (`TblAup`) и их структуре (`AupData`, `SprDiscipline`) по ID АУП или номеру АУП. Функции для этого должны быть либо в `maps.logic`, либо реализованы в `competencies_matrix.logic`, напрямую работая с `maps.models`. **Это критически важная зависимость.**
    *   **Запись:** Запись в таблицы `maps` из нашего модуля **не предполагается**.
*   **`auth` (Аутентификация):**
    *   Используются декораторы (`@login_required`, `@check_permission` - если будут права) для защиты эндпоинтов в `competencies_matrix/routes.py`.
    *   Необходимо получать `user_id` авторизованного пользователя для логгирования или проверки прав.
*   **`cabinet` (Академический Прогресс):**
    *   **Текущий этап:** Прямой интеграции **нет**. Модули работают параллельно.
    *   **Перспектива (MVP+):** Возможно, потребуется:
        *   **Передавать данные о связях "Дисциплина-ИДК"** из `CompetencyMatrix` в модуль `cabinet`, чтобы там можно было учитывать успеваемость по ИДК. Это потребует доработки API или моделей `cabinet`.
        *   **Отображать матрицу** или ее фрагменты в интерфейсе "Академического Прогресса".
    *   **Решение:** На этапе MVP фокусируемся на `competencies_matrix`. Интеграцию с `cabinet` планируем после стабилизации основного функционала.
*   **ЛК (Личный Кабинет):**
    *   Используется **только для аутентификации** через модуль `auth`. Прямых запросов к API ЛК из `competencies_matrix` не предполагается.
*   **NLP Модуль:**
    *   Предполагается как **отдельный компонент** (возможно, микросервис или библиотека), с которым взаимодействует `competencies_matrix.logic`.
    *   **Задачи:** Анализ текстов ПС/ФГОС, предложение формулировок ИДК, предложение связей "Дисциплина-ИДК".
    *   На этапе MVP можно реализовать **заглушки** для этих функций.

## 6. План Разработки (MVP и Далее)

**MVP (Минимально жизнеспособный продукт):**

1.  **БД:** Реализовать **основные** модели в `competencies_matrix/models.py` (ОП, ФГОС, ПС(базово), Компетенции, ИДК, Матрица, Ассоциативные таблицы).
2.  **API (Чтение):** Реализовать эндпоинты для получения списка ОП, деталей ОП (включая ФГОС, связанные АУП, ПС), списка дисциплин АУП (интеграция с `maps`), и **полных данных для отображения матрицы** (`GET /matrix/<aup_id>`).
3.  **API (Запись - Базово):** Реализовать эндпоинты для **ручного** создания/удаления связей в матрице (`POST/DELETE /matrix/link`). Реализовать **базовый CRUD** для ПК и ИПК (без глубокой связи с ПС и без NLP).
4.  **Интеграция с `maps`:** Обеспечить стабильное получение данных АУП.
5.  **Frontend (Базовый):** Реализовать интерфейс для выбора ОП/АУП, отображения дисциплин, ИДК и **ручного редактирования связей** в матрице.

**После MVP:**

1.  **Парсинг ПС:** Интегрировать и доработать `parsers.py` для **структурированного** извлечения данных из ПС (ТФ, действия, знания, умения) и сохранения их в БД. Реализовать API для загрузки и парсинга ПС.
2.  **Улучшенный CRUD для ПК/ИПК:** Добавить выбор ТФ при создании ПК, выбор действий/знаний/умений при создании ИПК и сохранение связей в `IndicatorPsLink`.
3.  **Интеграция NLP:**
    *   Реализовать вызовы к NLP-модулю для предложения связей "Дисциплина-ИДК".
    *   Реализовать помощь NLP при формулировании ИДК.
4.  **Отчеты и Аналитика:** Добавить API и UI для генерации отчетов (например, покрытие ИДК дисциплинами).
5.  **Интеграция с `cabinet`:** Продумать и реализовать механизм передачи данных о матрице и ИДК для учета успеваемости.
6.  **Уровни освоения:** (Если потребуется) Добавить модели и логику для уровней и дескрипторов.

## 7. Заключение

Модуль `competencies_matrix` является стратегически важным для развития системы поддержки образовательного процесса в университете. Важно придерживаться модульной архитектуры, четко определить модели данных и реализовать MVP, сфокусированный на ручном и полуавтоматическом формировании матрицы компетенций. Дальнейшее развитие будет включать углубленную работу с ПС, интеграцию NLP и взаимодействие с другими системами.

Если возникнут вопросы по структуре, логике или интеграции – не стесняйся спрашивать!