```markdown
# Руководство для разработчика: Модуль `competencies_matrix` (Актуальное состояние)

**Версия документа:** 1.2
**Дата:** [Текущая дата]

## 1. Введение и Цель Модуля

Этот документ описывает модуль `competencies_matrix`, являющийся частью бэкенда веб-приложения "Карты Дисциплин" и расширяющий его функционал возможностями для работы с матрицами компетенций.

**Основная цель** модуля — предоставить инструменты для **создания, управления и визуализации матриц распределения компетенций для образовательных программ (ОП)** в соответствии с требованиями ФГОС ВО и Профессиональных Стандартов (ПС). Модуль фокусируется на работе с Компетенциями (УК, ОПК, ПК) и **Индикаторами их Достижения (ИДК)**.

**Ключевые задачи, решаемые модулем (в текущей реализации и ближайших планах):**

1.  **Хранение данных:** Обеспечение структуры БД для ОП, ФГОС, ПС, компетенций, ИДК и связей матрицы. *(Структура создана через миграции)*.
2.  **Управление ИДК и Компетенциями:** Предоставление базового API для создания и чтения компетенций и индикаторов. *(Частично реализовано)*.
3.  **Формирование Матрицы:** Реализация API для получения данных, необходимых для отображения матрицы (список дисциплин АУП, список ИДК, существующие связи), и для ручного управления связями "Дисциплина-ИДК". *(API чтения реализовано, API редактирования - следующая задача)*.
4.  **Интеграция:** Взаимодействие с существующими данными модуля `maps` ("Карты Дисциплин") и использование общей системы аутентификации (`auth`). *(Интеграция чтения данных из `maps` реализована)*.
5.  **Парсинг ПС:** Включение базовой логики для обработки файлов Профессиональных Стандартов. *(Базовый парсинг реализован)*.

Модуль является логически обособленной частью, но интегрирован в основной бэкенд.

## 2. Архитектурное Размещение

Модуль `competencies_matrix` реализован как **Flask Blueprint** (`competencies_matrix_bp`) с префиксом `/api/competencies`. Регистрация Blueprint происходит в основном файле приложения `app.py` внутри фабрики `create_app`. Файл `competencies_matrix/app_to_integrate.py` **не используется** для регистрации.

**Расположение в структуре проекта:**

maps_backend/
├── ... (другие модули: administration, auth, cabinet, maps) ...
├── competencies_matrix/   # <<<--- НАШ МОДУЛЬ
│   ├── __init__.py        # Регистрация Blueprint, настройка обработчиков ошибок
│   ├── routes.py          # API эндпоинты (GET /matrix/<aup_id>, POST/DELETE /matrix/link и т.д.)
│   ├── models.py          # SQLAlchemy модели для НОВЫХ таблиц (competencies_*)
│   ├── logic.py           # Функции бизнес-логики (get_matrix_for_aup, update_matrix_link и т.д.)
│   ├── parsers.py         # Логика парсинга ПС (адаптировано из profstandard-lean.py)
│   ├── schemas.py         # (Опц.) Схемы Pydantic/Marshmallow (пока не реализованы)
│   └── utils.py           # (Пока не используется активно)
├── ... (общие файлы: app.py, config.py, migrations) ...

Модуль использует **общую базу данных MySQL**, объект `db` и модели из `maps.models`, конфигурацию из `config.py` и модуль аутентификации `auth`.

## 3. Структура Модуля `competencies_matrix`

*   `__init__.py`:** Создает `Blueprint`, задает префикс `/api/competencies`, регистрирует базовые обработчики ошибок 404/500 для этого Blueprint. Импортирует `routes.py`.
*   `routes.py`:** Определяет API эндпоинты. Текущие реализованные и **проверенные на базовую работоспособность** эндпоинты включают:
    *   `GET /programs`: Получение списка ОП.
    *   `GET /programs/<program_id>`: Получение деталей ОП.
    *   `GET /matrix/<aup_id>`: Получение данных для построения матрицы АУП (**ключевой эндпоинт MVP - возвращает 200 OK с данными**).
    *   `POST /competencies`: Создание новой компетенции (базовое).
    *   `POST /indicators`: Создание нового индикатора (базовое).
    *   `POST /profstandards/upload`: Загрузка и базовый парсинг файла ПС.
    *   `GET /health-check`: Проверка доступности модуля.
    Эндпоинты для **редактирования матрицы** (`POST/DELETE /matrix/link`) определены, но **логика не реализована/не протестирована**. Все эндпоинты (кроме health-check) защищены декоратором `@login_required(request)` из модуля `auth`. Запросы **делегируются** функциям из `logic.py`.
*   `models.py`:** Определяет SQLAlchemy модели для **новых таблиц** (префикс `competencies_`). Модели **синхронизированы** со структурой, создаваемой миграцией Alembic `a388922067b4...py` и последующими (включая `fgos_vo_id` в `Competency`). Включает **динамическое добавление** `relationship` к модели `AupData` из `maps.models` для связи с матрицей.
*   `logic.py`:** Содержит функции бизнес-логики. Основные реализованные функции:
    *   `get_educational_programs_list()`: Получает список ОП.
    *   `get_program_details()`: Получает детали ОП со связями.
    *   `get_matrix_for_aup()`: **Ключевая функция**, собирающая данные для матрицы. **Требует верификации корректности возвращаемых данных** и доработки логики фильтрации ПК.
    *   `update_matrix_link()`: **Заготовка** для создания/удаления записей в `CompetencyMatrix`. **Требует реализации/тестирования**.
    *   `create_competency()`, `create_indicator()`: Базовое добавление записей.
    *   `parse_prof_standard_file()`: Обрабатывает загруженный файл, вызывает парсер, сохраняет базовую информацию о ПС и Markdown.
*   `parsers.py`:** Содержит логику парсинга ПС. Текущая реализация фокусируется на извлечении кода/имени ПС и генерации Markdown. Извлечение детальной структуры (ОТФ, ТФ и т.д.) является **задачей для дальнейшей доработки**.
*   `schemas.py`, `utils.py`:** Пока не содержат значимой логики.

## 4. Ключевые Сущности и Поток Данных (Текущее Состояние)

Система оперирует сущностями, описанными в предыдущей версии документа (ОП, ФГОС, ПС, Компетенция, ИДК, АУП, AupData, Матрица).

**Текущий реализованный поток для отображения матрицы (`GET /matrix/<aup_id>`):**

1.  `routes.py` получает запрос с `aup_id`.
2.  Вызывается `logic.get_matrix_for_aup(aup_id)`.
3.  Функция запрашивает из БД (`db.session.query`):
    *   `AupInfo` (из `maps.models`), связанную `EducationalProgram` и `FgosVo`.
    *   Список `AupData` для `aup_id` (из `maps.models`).
    *   Список *всех* УК/ОПК и *всех* ПК с их индикаторами (из `competencies_matrix.models`) – **фильтрация по ОП/ФГОС для УК/ОПК и логика выборки ПК требуют доработки**.
    *   Существующие связи из `CompetencyMatrix`.
4.  `logic.py` форматирует полученные данные в структуру JSON.
5.  `routes.py` возвращает JSON клиенту.

## 5. Интеграция с Другими Модулями/Системами

*   **`maps`:** Активно **читает** данные `AupInfo`, `AupData`, `SprDiscipline`. Запись в `maps` не производится.
*   **`auth`:** Используется для защиты API (`@login_required`).
*   **`cabinet`:** **Нет** прямой интеграции на данный момент.
*   **ЛК:** Только через `auth` для аутентификации.
*   **NLP:** **Нет** интеграции на данный момент (функции возвращают пустые/заглушечные данные).

## 6. Управление Схемой и Данными

*   **Схема БД:** Определяется моделями (`*.models.py`) и управляется через **Alembic**. Актуальная структура **соответствует** последней примененной миграции.
*   **Создание/Обновление Схемы:** Выполняется **только** через `flask db upgrade`.
*   **Наполнение Данными:** Выполняется через команду `flask seed_db` (определена в `app.py`). **Команда реализована, использует `merge`, включает тестовые данные для MVP, но требует финальной верификации корректности вставленных данных**.

## 7. Текущий Статус и Ближайшие Задачи (Фокус MVP)

*   **Статус:**
    *   Структура модуля создана, интегрирована в `app.py`.
    *   Миграции Alembic применены, схема БД актуальна.
    *   Модели (`models.py`) синхронизированы с миграциями.
    *   Команда `seed_db` реализована, использует `merge`, включает тестовые данные.
    *   API `GET /matrix/<aup_id>` **реализован и возвращает 200 OK с данными**, но требует **проверки корректности данных**.
    *   API для редактирования матрицы (`POST/DELETE /matrix/link`) **определены, но логика не реализована/не протестирована**.
    *   Базовое API для CRUD компетенций/индикаторов и загрузки ПС реализовано.
*   **Ближайшие Задачи (для завершения MVP):**
    1.  **Верификация Данных:**
    *   [ ] Проверить корректность данных, вставленных `flask seed_db`, непосредственно в базе данных (через SQL-клиент). Убедиться в идемпотентности сидера.
    2.  **Доработка API `GET /matrix/<aup_id>`:**
    *   [ ] Сравнить JSON-ответ от API с тестовыми данными в БД и ожидаемыми результатами (названия, коды, формулировки, ID связей).
    *   [ ] Проверить и исправить **сортировку** `disciplines` и `competencies`.
    *   [ ] Доработать **фильтрацию ПК**: реализовать логику выборки только тех ПК, которые релевантны для ОП (например, на основе связанных с ОП профстандартов).
        *   [ ] Добавить возможность указать, что связь "ТФ - Дисциплина" - обязательна, на основании которого отображать или не отображать эти данные во фронт-енде.
    *   [ ] Убедиться, что фильтрация УК/ОПК по `fgos_vo_id` работает корректно.
    3.  **Реализация Редактирования Матрицы (API):**
        *   [ ] Протестировать и отладить `logic.update_matrix_link(...)`.
        *   [ ] Реализовать эндпоинты `POST /matrix/link` и `DELETE /matrix/link` в `routes.py` (используя `curl` или Postman).
    4.  **Frontend (Параллельно):**
        *   [ ] UI для выбора ОП и АУП.
        *   [ ] UI для отображения матрицы с чекбоксами и управления связями.
```