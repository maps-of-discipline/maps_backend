# Задачи по Разработке Модуля `competencies_matrix`

**Проект:** Академический Прогресс / Карты Дисциплин (Бэкенд + Фронтенд)
**Модуль:** `competencies_matrix`
**Версия Документа:** 1.4
**Дата:** [2025-04-15]

---

## 1. Цель и Определение MVP (Minimum Viable Product)

**Глобальная цель:** Создать подсистему для управления матрицами распределения компетенций для образовательных программ (ОП) Московского Политеха, интегрированную с существующим бэкендом "Карт Дисциплин" и системой аутентификации.

**Цель MVP:** Предоставить пользователям (методистам, администраторам) возможность **просматривать** матрицу компетенций для выбранного Академического Учебного Плана (АУП) и **вручную управлять связями** "Дисциплина-ИДК" через API и минимальный UI.

**Definition of Done (DoD) для MVP:**

1.  [x] Модуль `competencies_matrix` интегрирован в основной бэкенд (`app.py`).
2.  [x] Структура БД соответствует актуальным миграциям Alembic.
3.  [x] Команда `flask seed_db` выполняется и добавляет **корректные и верифицированные** тестовые данные для таблиц `competencies_*`.
4.  [x] API эндпоинт `GET /api/competencies/matrix/<aup_id>` возвращает `200 OK`, **корректно отсортированные и отфильтрованные** данные с ожидаемой структурой.
5.  [x] API эндпоинты `POST /api/competencies/matrix/link` и `DELETE /api/competencies/matrix/link` **полностью реализованы, протестированы** и позволяют корректно создавать/удалять связи в БД.
6.  [x] Реализован **минимальный UI** (Frontend, например, в `MatrixView.vue`), позволяющий:
    [x]   Выбрать АУП (из списка, полученного по ОП).
    [x]   Отобразить таблицу матрицы ("Дисциплины x ИДК") на основе данных от `GET /matrix/<aup_id>`.
    [x]   Отобразить чекбоксы, отражающие существующие связи.
    [x]   **Управлять связями** через изменение состояния чекбоксов (вызовы `POST/DELETE /matrix/link`).
7.  [x] API защищено базовой аутентификацией (`@login_required`) и проверкой одобрения (`@approved_required`).
8.  [ ] Добавлена возможность изменять информацию у ОПОП в той же форме, что и в `ProgramView.vue`.
    [ ]   Есть разграничение прав на чтение и на чтение-запись в зависимости от роли пользователя.
9.  [ ] Реализоован UI для ручного добавления ОПОП.
10. [ ] Реализована интеграция с Картами Дисциплин для получения данных об АУП.
    [ ]   Посылаются запросы к kd.mospolytech.ru для получения данных из БД, сделан healthcheck для проверки доступности БД у КД. Вероятно потребуется добавить endpoint специально для технической учётной записи (ТУЗ) для получения информации об АУП.
    [ ]   Реализована функция автоматического импорта всей информации по АУП из КД раз в день или при нажатии кнопки обновления (доступна админу). Информация добавляется или обновляется только если она не существует локально в БД, либо она новее информации, которая хранится локально в БД.
    [ ]   Реализована функция автоматического импорта актуальной информации из КД при выборе АУП, с rate limit в 5 секунд. При недоступности КД, высветится сообщение, что сервис Карты Дисциплин недоступен, и отображается сохранённая информация из БД.


---

## 2. Подготовка и Настройка Окружения

*   **Статус:** [x] Выполнено.
    *   Локальное окружение настроено.
    *   Миграции применены (включая `fgos_vo_id`).
    *   Проблемы инициализации исправлены.

---

## 3. Верификация Сидера и Данных (Перед началом Frontend)

*   **Задача:** Верификация данных после `flask seed_db`.
    *   **Статус:** [x] Выполнено.
        *   `flask seed_db` и `flask unseed_db` работают.

---

## 4. Доработка API и Логики Матрицы (Backend MVP)

*   **Задача:** Проверить и доработать **корректность данных и сортировку** в `GET /matrix/<aup_id>`.
    *   **Статус:** [-] **К выполнению**.
    *   **Приоритет:** **Высокий**.
    *   **Детали:**
        *   [ ] Проверить сортировку `disciplines` (семестр -> название/shifr) и `competencies` (тип -> код) в ответе API.
        *   [ ] **Реализовать фильтрацию ПК**: Определить стратегию (по ОП? по выбранным ПС для ОП?). Реализовать в `logic.get_matrix_for_aup`. **Пока можно оставить получение всех ПК, но пометить для следующего этапа.**
*   **Задача:** Финализировать и протестировать API для **управления связями**.
    *   **Статус:** [-] **К выполнению**.
    *   **Приоритет:** **Высокий**.
    *   **Детали:**
        *   [ ] Тщательно протестировать `logic.update_matrix_link` на разные сценарии (создание, удаление, дубликаты, несуществующие ID).
        *   [ ] Протестировать `POST /matrix/link` и `DELETE /matrix/link` через `curl` или Postman, проверяя ответы (статусы 201, 200, 404) и изменения в БД.

---

## 5. Frontend Разработка (MVP)

*   **Задача:** Создать базовый UI для **просмотра и редактирования** матрицы.
    *   **Статус:** [!] **Частично выполнено**.
    *   **Приоритет:** **Высокий**.
    *   **Детали:**
        *   [x] **`ProgramsView.vue`:**
            *   [x] Реализовать получение списка ОП из API (`GET /programs`).
            *   [x] Реализовать получение деталей ОП при клике (`GET /programs/<id>`), включая список связанных АУП.
            *   [x] Добавить навигацию к `MatrixView` с передачей `aupId`.
        *   [x] **`MatrixView.vue`:**
            *   [x] Реализовать получение `aupId` из роутера.
            *   [x] Реализовать получение данных для матрицы из API (`GET /matrix/<aupId>`).
            *   [x] Создать **компонент таблицы матрицы** (`MatrixTable.vue`):
                *   [x] Отображение заголовков (Дисциплины).
                *   [x] Отображение заголовков (Компетенции/ИДК, сгруппировано).
                *   [x] Отображение чекбоксов на пересечениях, состояние на основе `links` из API.
            *   [ ] Протестировать логику **обновления связей** при изменении чекбокса (вызов `POST/DELETE /matrix/link` через Pinia store).
        *   [x] **`stores/competenciesMatrix.ts` (Новый стор):**
            *   [x] Создать Pinia store.
            *   [x] Реализовать actions для вызова API (fetchPrograms, fetchProgramDetails, fetchMatrixData, addMatrixLink, deleteMatrixLink).
            *   [x] Реализовать state для хранения данных (программы, детали, матрица, статус загрузки).
            *   [x] Реализовать getters для удобного доступа к данным.

---

## 6. Базовый CRUD API (Поддержка Управления Данными)

*   **Задача:** Реализовать базовый CRUD для ОП, Компетенций, ИДК.
    *   **Статус:** [-] К выполнению.
    *   **Приоритет:** **Средний** (Нужно для наполнения системы после MVP).
    *   **Детали:**
        *   [ ] Реализовать недостающие `GET` (список/один), `PATCH`, `DELETE` эндпоинты для `/programs`, `/competencies`, `/indicators`.
        *   [ ] Добавить базовую валидацию входных данных (хотя бы проверку типов и наличия).
        *   [ ] (Опц. UI): Создать минимальные UI для просмотра/добавления ОП, Компетенций, ИДК в `ProgramsView.vue` и новом `CompetenciesAdminView.vue`.

---

## 7. Профессиональные Стандарты (ПС) (После MVP)

*   **Задача:** Доработка парсера ПС и связанного API/Логики.
    *   **Статус:** [-] К выполнению.
    *   **Приоритет:** Низкий.
    *   **Детали:**
        *   [ ] Извлечение структуры (ОТФ/ТФ/...).
        *   [ ] Сохранение структуры в БД.
        *   [ ] API для получения структуры ПС (`GET /profstandards/<code>`).
        *   [ ] UI для просмотра структуры (`ProfStandardsView.vue`).
*   **Задача:** Связывание ИДК с элементами ПС.
    *   **Статус:** [-] К выполнению.
    *   **Приоритет:** Низкий (но важно для полной картины).
    *   **Детали:**
        *   [ ] API и Логика для управления связями в `IndicatorPsLink`.
        *   [ ] UI для выбора элементов ПС при редактировании ИДК.

---

## 8. Рефакторинг, Тестирование и Документация

*   **Задача:** Улучшение качества кода и инфраструктуры.
    *   **Статус:** [-] К выполнению (Постоянно).
    *   **Приоритет:** Средний.
    *   **Детали:**
        *   [ ] Внедрить схемы валидации API (Pydantic?).
        *   [ ] Реализовать проверку прав доступа (`@check_permission` на основе ролей).
        *   [ ] Написать базовые тесты (pytest).
        *   [ ] Обновить документацию API (`api_documentation.md`).

---