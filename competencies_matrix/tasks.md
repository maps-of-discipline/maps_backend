# Задачи по Разработке Веб-приложения "Матрицы Компетенций"

**Проект:** Академический Прогресс / Карты Дисциплин (Бэкенд + Фронтенд)
**Компонент:** `competencies_matrix`
**Версия Документа:** 1.7
**Дата:** [2025-04-21] (Актуализировано)

---

## 1. Цель и Определение MVP (Minimum Viable Product) - Актуализировано

**Глобальная цель:** Создать веб-приложение (подсистему) для управления матрицами распределения компетенций для образовательных программ (ОП) Московского Политеха, интегрированное с существующим бэкендом "Карт Дисциплин" и системой аутентификации.

**Цель MVP (До защиты):** Предоставить пользователям (методистам, администраторам) возможность **импортировать данные об АУП** из выгрузок Excel, **просматривать** матрицу компетенций для выбранного Академического Учебного Плана (АУП), **вручную управлять связями** "Дисциплина-ИДК" в матрице, а также **управлять базовыми справочниками** (ОП, ПК/ИПК), **загружать профстандарты** (сохраняя их как текст/Markdown) и обеспечить базовое **разграничение прав доступа** по ролям.

**Definition of Done (DoD) для MVP (До защиты):**

1.  [x] Модуль `competencies_matrix` интегрирован в основной бэкенд (`app.py`).
2.  [x] Структура БД соответствует актуальным миграциям Alembic (`structure.md`).
3.  [x] Команда `flask seed_db` выполняется и добавляет **корректные и верифицированные** тестовые данные для таблиц `competencies_*` (примеры ОП, ФГОС, УК/ОПК/ПК, ИУК/ИОПК/ИПК).
4.  [x] Реализован механизм **импорта АУП из Excel-файлов** (предоставленных руководителем/Владом) в таблицы `tbl_aup` и `aup_data` через CLI команду (`flask import_aup --file <path>`) **и/или** API (`POST /api/competencies/aup/import-excel`). *(Функциональность импорта реализована и протестирована)*.
5.  [x] API эндпоинт `GET /api/competencies/programs` **реализован и возвращает 200 OK** со списком ОП.
6.  [x] API эндпоинт `GET /api/competencies/matrix/<aup_id>` возвращает `200 OK`, **корректно отсортированные и отфильтрованные** данные с ожидаемой структурой (Дисциплины, УК/ОПК из базы (от ФГОС), **все** созданные в системе ПК, ИДК, существующие связи).
7.  [x] API эндпоинты `POST /api/competencies/matrix/link` и `DELETE /api/competencies/matrix/link` **полностью реализованы, протестированы** и позволяют корректно создавать/удалять связи в БД.
8.  [x] Реализовано API для **базового CRUD** Образовательных Программ (`/programs`), Компетенций (`/competencies`) и Индикаторов (`/indicators`) **с фокусом на ПК/ИПК** (GET список, GET по ID, POST, PATCH/PUT, DELETE).
9.  [x] Реализовано API (`POST /api/competencies/profstandards/upload`) и логика для **загрузки файла ПС**, вызова `profstandard-lean.py` (или аналога) и сохранения результата (Markdown) в `competencies_prof_standard.parsed_content`.
10. [x] Реализован **минимальный UI** (Frontend), позволяющий:
    *   [x] Загружать файлы АУП (.xlsx) (если реализован API импорта).
    *   [x] Просматривать список ОП.
    *   [x] Выбирать ОП и затем АУП (из импортированных).
    *   [x] Отображать таблицу матрицы ("Дисциплины x ИДК") с чекбоксами.
    *   [x] **Вручную управлять связями** через изменение состояния чекбоксов (вызовы API `POST/DELETE /matrix/link`).
    *   [x] Просматривать список Компетенций/ИДК и базово управлять ПК/ИПК (`CompetenciesAdminView.vue`).
    *   [x] Загружать файлы ПС.
11. [x] API защищено аутентификацией и проверкой одобрения (`@login_required`, `@approved_required`).
12. [x] Реализована **базовая проверка прав доступа** (Админ - всё, Методист - матрица, чтение + CRUD для ПК/ИПК) с использованием декораторов (`@admin_only`) или проверок ролей в логике.

---

## 2. Ближайшие Задачи (До защиты, ~1 спринт) - Требуется Финализация

*   **Задача 1:** **Финализация Импорта АУП из Excel.**
    *   **Статус:** [-] **К выполнению/Проверке**.
    *   **Приоритет:** **Критический**.
    *   **Детали:**
        *   [ ] Проверить/доработать существующий код импорта (CLI или API) на предмет корректности парсинга предоставленных Excel-файлов.
        *   [ ] **Backend:** Убедиться, что импорт корректно создает/связывает записи в `tbl_aup`, `aup_data` и `EducationalProgram`.
        *   [ ] **Frontend:** Если используется API, убедиться, что UI для загрузки файла работает корректно.
        *   [ ] Наполнить локальную БД актуальными данными АУП (например, '03 - 000020763 - 2024 Веб-технологии...xlsx').
*   **Задача 2:** **Финализация и Тестирование CRUD API и UI для Справочников (ОП, ПК/ИПК).**
    *   **Статус:** [-] **К выполнению/Проверке**.
    *   **Приоритет:** **Высокий**.
    *   **Детали:**
        *   [ ] **Backend:** Протестировать все эндпоинты (`GET`, `POST`, `PATCH`, `DELETE`) для `/programs`, `/competencies`, `/indicators` с фокусом на ПК/ИПК. Проверить валидацию.
        *   [ ] **Frontend:** Протестировать UI (`CompetenciesAdminView.vue` или аналог) для CRUD ОП, Компетенций и ИДК (особенно ПК/ИПК).
*   **Задача 3:** **Финализация и Тестирование Загрузки ПС.**
    *   **Статус:** [-] **К выполнению/Проверке**.
    *   **Приоритет:** **Высокий**.
    *   **Детали:**
        *   [ ] **Backend:** Убедиться, что `POST /profstandards/upload` стабильно работает с реальными файлами HTML/DOCX, корректно вызывает парсер (`profstandard-lean.py` / `parsers.py`) и сохраняет Markdown и метаданные ПС.
        *   [ ] **Frontend:** Протестировать UI для загрузки файла ПС.
*   **Задача 4:** **Финализация и Тестирование Матрицы (API + UI).**
    *   **Статус:** [-] **К выполнению/Проверке**.
    *   **Приоритет:** **Высокий**.
    *   **Детали:**
        *   [ ] **Backend:** Проверить и исправить сортировку/фильтрацию в `GET /matrix/<aup_id>`. Убедиться, что отображаются нужные ПК (например, связанные с ОП).
        *   [ ] **Backend & Frontend:** Тщательно протестировать весь цикл редактирования связей (клик на чекбокс -> вызов API `POST/DELETE /matrix/link` -> обновление UI/БД). Проверить на разных сценариях.
        *   [ ] **Frontend:** Проверить UI выбора ОП/АУП, отображение матрицы, индикаторы загрузки, обработку ошибок.
*   **Задача 5:** **Финализация Разграничения Прав Доступа.**
    *   **Статус:** [-] **К выполнению/Проверке**.
    *   **Приоритет:** **Высокий**.
    *   **Детали:**
        *   [ ] Проверить применение декораторов (`@admin_only`, `@approved_required`) или логики проверки ролей ко всем необходимым API эндпоинтам.
        *   [ ] Убедиться, что права соответствуют требованиям (Админ - CRUD справочников, Методист - CRUD матрицы и просмотр/CRUD ПК/ИПК).
*   **Задача 6:** **Подготовка Демонстрации.**
    *   **Статус:** [-] **К выполнению**.
    *   **Приоритет:** **Критический**.
    *   **Детали:**
        *   [ ] Подготовить демонстрационный сценарий, показывающий весь реализованный MVP функционал (импорт АУП, просмотр ОП, выбор АУП, просмотр матрицы, управление связями, управление ПК/ИПК, загрузка ПС).
        *   [ ] Убедиться, что приложение стабильно работает на локальной машине с подготовленными данными.
        *   [ ] Подготовить краткое описание реализованного функционала для защиты.

---

## 3. Задачи После Защиты (Перспектива, ВКР)

*   **Задача:** Детальный **парсинг структуры ПС и сохранение в БД**.
    *   **Статус:** [-] К выполнению.
    *   **Приоритет:** Высокий (для ВКР).
    *   **Детали:** Доработка парсера (`profstandard-lean.py` / `parsers.py`), логики сохранения ОТФ/ТФ/Знаний/Умений в связанные таблицы БД.
*   **Задача:** Реализовать **механизм формирования ПК на основе ПС**.
    *   **Статус:** [-] К выполнению.
    *   **Приоритет:** Высокий (для ВКР).
    *   **Детали:** Разработка API и UI для связывания ПК/ИПК с элементами структуры ПС (ТФ, знаниями, умениями).
*   **Задача:** Глубокая **интеграция с Картами Дисциплин (получение АУП через API КД)**.
    *   **Статус:** [-] К выполнению.
    *   **Приоритет:** Средний/Высокий (Улучшение UX, Актуальность данных).
    *   **Детали:** Реализовать получение актуальных данных АУП из API КД, механизм синхронизации или прямого использования данных.
*   **Задача:** Интеграция с **NLP-модулем** (предложение связей, анализ).
    *   **Статус:** [-] К выполнению.
    *   **Приоритет:** Средний (Инновационная часть ВКР, если успеваем).
    *   **Детали:** Определить формат взаимодействия, реализовать вызовы к NLP для предложений связей "Дисциплина-ИДК", "ИДК-ПС". (См. раздел 4).
*   **Задача:** Учет **успеваемости по ИДК**.
    *   **Статус:** [-] К выполнению.
    *   **Приоритет:** Средний/Низкий.
    *   **Детали:** Доработка модуля `cabinet` или интеграция с ним для привязки оценок студентов к ИДК матрицы.
*   **Задача:** Рефакторинг, Тестирование (unit/integration), Документация API, Описание для ВКР.
    *   **Статус:** [-] К выполнению (Постоянно).
    *   **Приоритет:** Постоянный.

---

## 4. Форма взаимодействия с NLP-модулем (Предложение для Задачи 3.4)

На данном этапе (Перспектива ВКР), предлагается реализовать взаимодействие с NLP-модулем по модели **"Запрос-Ответ" через REST API**.

*   **NLP-модуль:** Представляет собой отдельный сервис (может быть написан на любом языке, с использованием библиотек для NLP), который предоставляет свой набор API эндпоинтов.
*   **Backend веб-приложения (`competencies_matrix`):** Выступает в роли **клиента** NLP-сервиса.

**Предлагаемые эндпоинты NLP-сервиса (пример):**

*   `POST /analyze-profstandard`: Принимает текст профстандарта (например, в Markdown), возвращает структурированный JSON с извлеченными ОТФ, ТФ, действиями, умениями, знаниями.
*   `POST /match-indicator-ps`: Принимает формулировку ИДК и список (или текст) элементов ПС (ТФ, умений, знаний), возвращает предложения по связям с оценкой релевантности.
*   `POST /suggest-matrix-links`: Принимает список дисциплин (с их описаниями/РПД) и список ИДК, возвращает предложения по связям "Дисциплина-ИДК" с оценкой релевантности.

**Взаимодействие из `competencies_matrix.logic`:**

Функции в `logic.py` (например, при сохранении ПС, создании ИДК, запросе данных для матрицы) будут выполнять **HTTP POST-запросы** к соответствующим эндпоинтам NLP-сервиса, отправлять им необходимые данные и обрабатывать полученные JSON-ответы. Для этого потребуется использовать библиотеку типа `requests` в Python.

**Пример вызова (псевдокод):**

```python
# В logic.py
import requests
NLP_SERVICE_URL = "http://localhost:8001/api/nlp" # Пример URL

def process_prof_standard_with_nlp(markdown_text):
    try:
        response = requests.post(f"{NLP_SERVICE_URL}/analyze-profstandard", json={"text": markdown_text}, timeout=30)
        response.raise_for_status() # Выбросит исключение для плохих статусов (4xx, 5xx)
        nlp_result = response.json()
        # TODO: Сохранить nlp_result (структуру ПС) в БД
        return nlp_result
    except requests.exceptions.RequestException as e:
        print(f"Error calling NLP service: {e}")
        return None

def suggest_indicator_links(indicator_formulation, profstandard_elements):
    try:
        response = requests.post(f"{NLP_SERVICE_URL}/match-indicator-ps", json={"indicator": indicator_formulation, "ps_elements": profstandard_elements}, timeout=15)
        response.raise_for_status()
        suggestions = response.json().get('suggestions', [])
        return suggestions
    except requests.exceptions.RequestException as e:
        print(f"Error calling NLP service for suggestions: {e}")
        return []
```

---