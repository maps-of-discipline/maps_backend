# Структура проекта maps_backend

Ниже представлена детальная структура проекта с описанием назначения каждого модуля и файла.

## Основная структура приложения

```
maps_backend/
├── administration/       # Модуль администрирования системы
│   ├── __init__.py        # Инициализация пакета administration, регистрация Blueprint
│   ├── admin_view.py      # Views для админ-интерфейса на базе Flask-Admin
│   ├── base.py            # Базовые классы и утилиты для админ-views (ModelView, FileAdmin и др.)
│   ├── routes.py          # Роуты для Blueprint администрирования
│   └── crud/              # Специализированные CRUD операции для админки
├── auth/                # Модуль аутентификации и авторизации
│   ├── __init__.py        # Инициализация пакета auth, регистрация Blueprint
│   ├── cli.py             # CLI команды (например, для создания пользователей, ролей)
│   ├── logic.py           # Логика аутентификации и авторизации (логин, JWT токены, права доступа)
│   ├── models.py          # SQLAlchemy модели для пользователей, ролей, прав доступа, токенов
│   └── routes.py          # API endpoints для аутентификации (логин, логаут, регистрация, управление токенами)
├── cabinet/             # Модуль "Академический кабинет"
│   ├── __init__.py        # Инициализация пакета cabinet, регистрация Blueprint
│   ├── cabinet.py         # Основной файл с Blueprint и роутами для управления:
│   │                        # - дисциплинами
│   │                        # - занятиями и оценками
│   │                        # - студенческими группами
│   │                        # - расписанием
│   │                        # - отчетами
│   ├── models.py          # SQLAlchemy модели для таблиц "Академического кабинета"
│   ├── lib/               # Вспомогательные библиотеки для сложных операций
│   │   ├── generate_discipline_table.py # Генерация таблицы дисциплин
│   │   ├── generate_empty_rpd.py        # Создание рабочих программ дисциплин (РПД)
│   └── utils/             # Утилиты для работы модуля cabinet
├── maps/                # Основной модуль "Карты Дисциплин" (содержит модели AUP, Disciplines и т.д.)
│   ├── __init__.py        # Инициализация пакета maps, регистрация Blueprint
│   ├── models.py          # SQLAlchemy модели для таблиц "Карты Дисциплин":
│   │                        # - AupInfo (учебные планы)
│   │                        # - AupData (дисциплины в учебных планах)
│   │                        # - справочники (факультеты, кафедры, группы и т.д.)
│   ├── routes.py          # API endpoints для работы с учебными планами
│   ├── logic/             # Бизнес-логика модуля
│   │   ├── tools.py          # Различные утилиты для работы с учебными планами
│   │   ├── excel_check.py    # Проверки для импорта данных из Excel
│   │   ├── save_into_bd.py   # Функции сохранения данных в БД
│   │   ├── take_from_bd.py   # Функции получения данных из БД
│   │   └── print_excel.py    # Экспорт данных в Excel
│   ├── templates/         # HTML шаблоны модуля Maps
│   └── static/            # Статические файлы модуля Maps
├── competencies_matrix/ # Модуль для работы с матрицами компетенций
│   ├── __init__.py        # Регистрация Blueprint с префиксом /api/competencies
│   ├── api_documentation.md # Документация API
│   ├── description.md      # Описание модуля и его функциональности
│   ├── logic.py           # Бизнес-логика: 
│   │                        # - обработка запросов API
│   │                        # - взаимодействие с БД
│   │                        # - бизнес-правила формирования матрицы
│   ├── models.py          # SQLAlchemy модели для таблиц компетенций:
│   │                        # - FgosVo (ФГОС ВО)
│   │                        # - EducationalProgram (образовательные программы)
│   │                        # - ProfStandard (профстандарты) и их структура (OTF, LaborFunction)
│   │                        # - Competency (компетенции) и Indicator (индикаторы)
│   │                        # - CompetencyMatrix (матрица компетенций)
│   ├── parsers.py         # Парсеры для работы с профессиональными стандартами:
│   │                        # - извлечение данных из PDF/HTML
│   │                        # - структурирование ОТФ, ТФ, умений, знаний
│   ├── profstandard-lean.py # Скрипт для обработки профстандартов
│   ├── routes.py          # API endpoints для:
│   │                        # - управления образовательными программами
│   │                        # - работы с компетенциями и ИДК
│   │                        # - управления матрицей компетенций
│   ├── proposed_structure.md # Описание структуры проекта (этот файл)
│   ├── tasks.md            # Список задач по разработке модуля
│   └── test_data.sql      # Тестовые данные для модуля
├── unification/         # Модуль унификации дисциплин
│   ├── __init__.py        # Инициализация модуля
│   ├── models.py          # Модели данных для унифицированных дисциплин
│   └── routes.py          # API endpoints для работы с унифицированными дисциплинами
├── utils/               # Общие утилиты приложения
│   ├── __init__.py       
│   └── handlers.py        # Обработчики ошибок, логирование
├── migrations/          # Alembic migrations для управления изменениями схемы БД
│   ├── alembic.ini        # Конфигурация Alembic
│   ├── env.py             # Среда выполнения миграций
│   ├── README             # Описание миграций
│   ├── script.py.mako     # Шаблон для новых миграций
│   └── versions/          # Файлы миграций
│       └── a388922067b4_correct_models_for_competencies_and_.py  # Последняя миграция компетенций
├── static/              # Общие статические файлы приложения
│   ├── docx_templates/    # Шаблоны документов Word
│   └── temp/              # Временные файлы
├── app.py               # Главный файл приложения Flask:
│                          # - инициализация приложения
│                          # - регистрация всех Blueprint'ов
│                          # - настройка подключения к БД
│                          # - обработка ошибок
├── config.py            # Файл конфигурации приложения
├── Dockerfile           # Файл для сборки Docker образа
├── gunicorn_config.py   # Настройки сервера Gunicorn для production
├── minimal_schema.sql   # Минимальная схема БД для начального запуска
├── proper_schema.md     # Описание структуры БД (не используется для создания БД, только для документации)
├── README.md            # Основное описание проекта
├── requirements.txt     # Файл со списком зависимостей Python
└── take_from_bd.py      # Вспомогательный файл для работы с БД
```

## Ключевые аспекты архитектуры

1. **Модульная структура**: Приложение разделено на отдельные модули с помощью Flask Blueprints:
   - `maps` - Модуль для работы с академическими учебными планами и картами дисциплин
   - `competencies_matrix` - Модуль для работы с компетенциями и их матрицами 
   - `cabinet` - Модуль для работы с учебным процессом (учебные планы, группы, студенты)
   - `auth` - Модуль для работы с аутентификацией и авторизацией
   - `administration` - Модуль для административных функций
   - `unification` - Модуль для унификации дисциплин

2. **ORM-подход**: Используется SQLAlchemy для работы с базой данных:
   - Абстракция от конкретного типа СУБД
   - Типобезопасность и валидация на уровне моделей
   - Управление схемой БД через миграции Alembic

3. **REST API**: Все взаимодействие с фронтендом происходит через RESTful API с JSON-форматом.

4. **Безопасность**: JWT-аутентификация с системой ролей и разграничения прав доступа.

5. **Интеграция**: Модуль `competencies_matrix` интегрируется с существующими модулями:
   - Использует модели из `maps.models` (AupInfo, AupData)
   - Работает с единой системой аутентификации из `auth`

## База данных

База данных актуальной версии содержит следующие основные компоненты:

1. **Образовательные программы и стандарты**:
   - `competencies_fgos_vo` - ФГОС ВО
   - `competencies_educational_program` - Образовательные программы 
   - `competencies_educational_program_aup` - Связь ОП с АУП
   - `competencies_prof_standard` - Профессиональные стандарты
   - `competencies_educational_program_ps` - Связь ОП с профстандартами

2. **Профессиональные стандарты и их структура**:
   - `competencies_generalized_labor_function` - Обобщенные трудовые функции (ОТФ)
   - `competencies_labor_function` - Трудовые функции (ТФ)
   - `competencies_labor_action` - Трудовые действия
   - `competencies_required_skill` - Необходимые умения
   - `competencies_required_knowledge` - Необходимые знания

3. **Компетенции и матрица**:
   - `competencies_competency_type` - Типы компетенций (УК, ОПК, ПК)
   - `competencies_competency` - Компетенции
   - `competencies_indicator` - Индикаторы достижения компетенций
   - `competencies_indicator_ps_link` - Связь индикаторов с трудовыми функциями
   - `competencies_matrix` - Матрица компетенций (связь индикаторов с дисциплинами АУП)

4. **Учебные планы и дисциплины**:
   - `tbl_aup` - Академические учебные планы
   - `aup_data` - Дисциплины в учебных планах
   - `d_blocks`, `d_modules`, `d_part` - Справочники для структуры учебных планов
   - `d_control_type`, `d_period` - Типы контроля и периоды обучения
   - `spr_discipline` - Справочник дисциплин
   - `unification_discipline` - Унифицированные дисциплины

5. **Пользователи и права доступа**:
   - `tbl_users` - Пользователи
   - `roles` - Роли пользователей
   - `user_roles` - Связь пользователей с ролями
   - `tbl_token` - Токены для аутентификации

6. **Организационная структура**:
   - `spr_faculty` - Факультеты
   - `tbl_department` - Кафедры
   - `tutors` - Преподаватели
   - `study_group` - Учебные группы
   - `students` - Студенты

7. **Учебный процесс** (модуль cabinet):
   - `discipline_table`, `grade_table` - Таблицы дисциплин и оценок
   - `topic` - Темы занятий
   - `grade_type`, `grade_column`, `grades` - Система оценивания

8. **Система аудита изменений**:
   - `Revision` - Ревизии изменений
   - `ChangeLog` - Журнал изменений

## Управление структурой базы данных

Структура базы данных управляется через систему миграций Alembic, которая позволяет:

1. **Версионировать изменения схемы** - каждая миграция имеет уникальный идентификатор и зависимости
2. **Применять изменения последовательно** - система отслеживает текущую версию БД
3. **Откатывать изменения** - каждая миграция содержит код для отката (downgrade)
4. **Автоматически генерировать миграции** на основе изменений в моделях SQLAlchemy

Файл `proper_schema.md` содержит описание ключевых аспектов структуры базы данных и служит для документации, но не используется напрямую для создания или изменения БД.

## Интеграция с фронтендом

Фронтенд приложения (`cabinet_frontend`) взаимодействует с бэкендом через REST API. Основные точки взаимодействия:

1. **Аутентификация и авторизация** - `/api/auth/login`, `/api/auth/token`
2. **Работа с картами дисциплин** - `/api/maps/...`
3. **Работа с матрицами компетенций** - `/api/competencies/...`
4. **Академический кабинет** - `/api/cabinet/...`