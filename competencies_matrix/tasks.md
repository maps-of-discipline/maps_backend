```markdown
# Задачи по Разработке Модуля `competencies_matrix`

**Проект:** Академический Прогресс / Карты Дисциплин (Бэкенд)
**Модуль:** `competencies_matrix`
**Версия Документа:** 1.2
**Дата:** [Текущая дата]

---

## 1. Цель и Определение MVP (Minimum Viable Product)

**Глобальная цель:** Создать подсистему для управления матрицами распределения компетенций для образовательных программ (ОП) Московского Политеха, интегрированную с существующим бэкендом "Карт Дисциплин" и системой аутентификации.

**Цель MVP:** Предоставить пользователям (методистам, администраторам) возможность **просматривать** матрицу компетенций для выбранного Академического Учебного Плана (АУП) и **вручную управлять связями** между дисциплинами этого АУП и Индикаторами Достижения Компетенций (ИДК).

**Definition of Done (DoD) для MVP:**

1.  [x] Модуль `competencies_matrix` интегрирован в основной бэкенд (`app.py`).
2.  [x] Структура БД соответствует актуальным миграциям Alembic (включая `a388922067b4...` и миграцию для `fgos_vo_id`).
3.  [x] Команда `flask seed_db` выполняется и добавляет тестовые данные.
4.  [x] API эндпоинт `GET /api/competencies/matrix/<aup_id>` возвращает `200 OK` и JSON с ожидаемой структурой.
5.  [ ] **Проверить корректность данных** от `GET /matrix/<aup_id>` на тестовом АУП.
6.  [ ] API эндпоинты `POST /api/competencies/matrix/link` и `DELETE /api/competencies/matrix/link` реализованы и позволяют создавать/удалять связи.
7.  [ ] Реализован **минимальный** UI (Frontend), позволяющий выбрать АУП, отобразить матрицу и управлять связями.
8.  [x] API защищено базовой аутентификацией (`@login_required`).

---

## 2. Подготовка и Настройка Окружения

*   **Задача:** Настроить локальное окружение.
    *   **Статус:** [x] Выполнено.
*   **Задача:** Применить все миграции Alembic.
    *   **Статус:** [x] Выполнено.
*   **Задача:** Добавить FK `fgos_vo_id` в модель `Competency` и миграцию.
    *   **Статус:** [x] Выполнено (Предполагается, что сделано для успешного сидинга).
*   **Задача:** Исправить проблемы инициализации.
    *   **Статус:** [x] Выполнено (Ошибка `RuntimeError` исправлена).

---

## 3. Верификация Сидера и Данных MVP

*   **Задача:** Сделать команду `seed_db` идемпотентной и полной для MVP.
    *   **Статус:** [x] Выполнено (Реализовано с `merge` и проверками).
*   **Задача:** **Верифицировать** данные после `flask seed_db`.
    *   **Статус:** [-] **К выполнению**.
    *   **Приоритет:** Высокий.
    *   **Подзадачи:**
        *   [ ] Проверить наличие и корректность данных для AUP 101, ОП 1, ФГОС 1, дисциплин 1001-1003 (`spr_discipline`, `aup_data`), компетенций 1, 5, 107, 201, индикаторов 10-12, 50, 170, 210 и связей в `competencies_matrix` **непосредственно в базе данных**.
        *   [ ] Убедиться, что повторный запуск `flask seed_db` не вызывает ошибок и не дублирует/изменяет данные.
        *   [ ] Убедиться, что тестовый пользователь 'testuser' создан с ролью 'methodologist' (или 'admin').

---

## 4. Отладка и Доработка API Матрицы (MVP)

*   **Задача:** Отладить и **проверить корректность данных** от `GET /matrix/<aup_id>`.
    *   **Статус:** [-] **К выполнению**.
    *   **Приоритет:** Высокий.
    *   **Зависимости:** Верифицированный сидер.
    *   **Подзадачи:**
        *   [ ] Сравнить JSON-ответ от API с тестовыми данными в БД и ожидаемыми результатами (названия, коды, формулировки, ID связей).
        *   [ ] Проверить и исправить **сортировку** `disciplines` (по семестру, затем по названию/shifr) и `competencies` (по типу, затем по коду).
        *   [ ] Доработать **фильтрацию ПК**: реализовать логику выборки только тех ПК, которые релевантны для ОП (например, на основе связанных с ОП профстандартов). **Для MVP можно пока оставить получение всех ПК.**
        *   [ ] Убедиться, что фильтрация УК/ОПК по `fgos_vo_id` работает (если поле добавлено и заполнено сидером).
*   **Задача:** Реализовать API для **управления связями** в матрице.
    *   **Статус:** [-] **К выполнению**.
    *   **Приоритет:** Высокий (для MVP).
    *   **Подзадачи:**
        *   [ ] Протестировать и отладить `logic.update_matrix_link(...)`.
        *   [ ] Реализовать и протестировать `POST /matrix/link` и `DELETE /matrix/link` в `routes.py` (используя `curl` или Postman).

---

## 5. Frontend Разработка (MVP)

*   **Задача:** Создать базовый UI для отображения и редактирования матрицы.
    *   **Статус:** [-] **К выполнению**.
    *   **Приоритет:** Высокий (для MVP).
    *   **Подзадачи:**
        *   [ ] **Выбор АУП:** Реализовать механизм выбора АУП (например, через выпадающий список, получая ОП и их АУП из API `/programs/<id>`).
        *   [ ] **Маршрутизация:** Настроить Vue Router для страницы матрицы (например, `/matrix/:aupId`).
        *   [ ] **Состояние (Pinia):** Создать стор(ы) для хранения выбранного `aup_id`, загруженных данных матрицы (`disciplines`, `competencies`, `links`), статуса загрузки и ошибок.
        *   [ ] **Компонент Матрицы:** Создать Vue-компонент, который:
            *   Принимает `aup_id`.
            *   Вызывает действие стора для загрузки данных через `GET /matrix/<aup_id>`.
            *   Отображает таблицу: строки - `disciplines`, столбцы - `competencies` (сгруппированные), ячейки - `indicators`.
            *   В ячейках на пересечении Дисциплина-Индикатор отображает чекбокс, состояние которого (`checked`) соответствует наличию связи в `links`.
        *   [ ] **Редактирование Связей:** Реализовать обработчик изменения состояния чекбокса, который вызывает действия стора для отправки `POST /matrix/link` (при установке) или `DELETE /matrix/link` (при снятии). Обновить состояние `links` в сторе после успешного ответа API.

---

## 6. Базовый CRUD API (Вне MVP, но нужно для управления)

*   **Задача:** Реализовать CRUD для Образовательных Программ (ОП).
    *   **Статус:** [-] К выполнению.
    *   **Приоритет:** Средний.
    *   **Подзадачи:**
        *   [ ] `logic`: Функции `create_program`, `get_program`, `update_program`, `delete_program`.
        *   [ ] `routes`: Эндпоинты `POST /programs`, `GET /programs/<id>`, `PATCH /programs/<id>`, `DELETE /programs/<id>`.
        *   [ ] Добавить защиту и базовую валидацию.
*   **Задача:** Реализовать CRUD для Компетенций.
    *   **Статус:** [-] К выполнению.
    *   **Приоритет:** Средний.
    *   **Подзадачи:**
        *   [ ] `logic`: Функции `get_competencies` (с фильтрами), `get_competency`, `update_competency`, `delete_competency`.
        *   [ ] `routes`: Эндпоинты `GET /competencies`, `GET /competencies/<id>`, `PATCH /competencies/<id>`, `DELETE /competencies/<id>`. (POST уже частично есть).
        *   [ ] Добавить защиту и валидацию.
*   **Задача:** Реализовать CRUD для Индикаторов.
    *   **Статус:** [-] К выполнению.
    *   **Приоритет:** Средний.
    *   **Подзадачи:**
        *   [ ] `logic`: Функции `get_indicators` (с фильтром по competency_id), `get_indicator`, `update_indicator`, `delete_indicator`.
        *   [ ] `routes`: Эндпоинты `GET /indicators`, `GET /indicators/<id>`, `PATCH /indicators/<id>`, `DELETE /indicators/<id>`. (POST уже частично есть).
        *   [ ] Добавить защиту и валидацию.

---

## 7. Профессиональные Стандарты (ПС)

*   **Задача:** Доработка парсера ПС для извлечения структуры.
    *   **Статус:** [-] К выполнению.
    *   **Приоритет:** Низкий (для MVP), Средний (для полной функциональности).
    *   **Подзадачи:**
        *   [ ] Модифицировать `parsers.py :: parse_uploaded_prof_standard` для возврата словаря со структурой (ОТФ, ТФ, Действия, Знания, Умения).
        *   [ ] Модифицировать `logic.py :: parse_prof_standard_file` для сохранения этой структуры в связанные таблицы БД (`competencies_generalized_labor_function` и т.д.).
*   **Задача:** Реализовать API для работы с ПС.
    *   **Статус:** [-] К выполнению.
    *   **Приоритет:** Низкий (для MVP).
    *   **Подзадачи:**
        *   [ ] `GET /profstandards`: Список ПС.
        *   [ ] `GET /profstandards/<code>`: Получение ПС по коду (включая структуру ОТФ/ТФ).
        *   [ ] (Возможно) CRUD для ручного редактирования ПС/ТФ.
*   **Задача:** Реализовать связь ПК/ИДК с элементами ПС.
    *   **Статус:** [-] К выполнению.
    *   **Приоритет:** Низкий (для MVP), Высокий (для соответствия требованиям ОП).
    *   **Подзадачи:**
        *   [ ] Доработать `logic.create_competency` для установки `based_on_labor_function_id`.
        *   [ ] Доработать `logic.create_indicator` (и `update`) для сохранения связей в `IndicatorPsLink`.
        *   [ ] Реализовать API для управления связями `IndicatorPsLink`.
        *   [ ] Реализовать UI для выбора ТФ при создании ПК и для привязки ИДК к элементам ПС.

---

## 8. Рефакторинг, Тестирование и Документация

*   **Задача:** Внедрить схемы валидации API (Pydantic/Marshmallow).
    *   **Статус:** [-] К выполнению.
    *   **Приоритет:** Средний.
*   **Задача:** Реализовать ролевую модель доступа (`@check_permission`).
    *   **Статус:** [-] К выполнению.
    *   **Приоритет:** Средний.
*   **Задача:** Написать Unit и Интеграционные тесты (pytest).
    *   **Статус:** [-] К выполнению.
    *   **Приоритет:** Средний/Высокий.
*   **Задача:** Улучшить логирование и обработку ошибок.
    *   **Статус:** [-] К выполнению (Постоянно).
*   **Задача:** Написать/Обновить документацию API (Swagger/OpenAPI).
    *   **Статус:** [-] К выполнению.
    *   **Приоритет:** Средний.
*   **Задача:** Написать руководство пользователя/методиста.
    *   **Статус:** [-] К выполнению.
    *   **Приоритет:** Средний/Низкий.

---

## 9. Будущие Возможности (Post-MVP)

*   [ ] Интеграция с NLP-сервисом для предложений связей в матрице.
*   [ ] Интеграция с NLP для помощи в формулировании ИДК на основе ПС.
*   [ ] Генерация отчетов (покрытие ИДК, соответствие ПС и т.д.).
*   [ ] Управление версиями ОП, ФГОС, ПС, Матриц.
*   [ ] Более глубокая интеграция с модулем `cabinet` (учет успеваемости по ИДК).
*   [ ] Визуализация матриц и связей.

---

**Комментарий о `proper_schema.md`:**

Файл `proper_schema.md` (или аналогичный `.sql` файл со схемой) был полезен на **этапе проектирования** базы данных. Он служил "чертежом". Сейчас, когда структура БД создана и управляется через модели SQLAlchemy (`*.models.py`) и миграции Alembic (`migrations/versions/*.py`), **именно код моделей и файлы миграций являются актуальным источником истины** о структуре БД.

**Нужно ли обновлять `proper_schema.md`?** Не обязательно. Его можно оставить как артефакт проектирования или обновить вручную, если хочется иметь актуальное *визуальное* представление схемы (например, для документации). Но он **не используется** непосредственно при разработке или управлении БД. При любых сомнениях или изменениях нужно смотреть в код моделей и миграций.

**Дальнейшие действия:** Сфокусируйся на **пункте 3 (Верификация Сидера)** и **пункте 4 (Отладка API Матрицы)**. Как только ты уверен, что API `GET /matrix/<aup_id>` возвращает *правильные* данные, можно параллельно начинать **пункт 5 (Frontend Разработка)** и доделывать API для редактирования связей (`POST/DELETE /matrix/link`).
```
