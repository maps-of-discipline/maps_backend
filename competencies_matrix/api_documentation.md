# API Документация: Модуль Матрицы Компетенций (`competencies_matrix`)

**Версия API:** 0.1.0 (MVP)
**Дата:** 2025-04-10
**Базовый URL:** `/api/competencies`

## 1. Введение

Данный документ описывает API эндпоинты, предоставляемые модулем `competencies_matrix`. Модуль предназначен для управления образовательными программами (ОП), компетенциями, индикаторами их достижения (ИДК) и формирования матриц распределения компетенций по дисциплинам академических учебных планов (АУП).

Этот API используется фронтенд-приложением (Vue 3) для отображения и редактирования данных.

## 2. Аутентификация

Все эндпоинты (кроме `/health-check`) требуют аутентификации пользователя. Аутентификация осуществляется через **Bearer Token** в заголовке `Authorization`.

**Пример заголовка:**
`Authorization: Bearer <YOUR_ACCESS_TOKEN>`

Токен доступа (`access_token`) получается через эндпоинт `/api/auth/login` (из модуля `auth`). Дополнительно, для большинства эндпоинтов требуется, чтобы учетная запись пользователя была одобрена администратором (`approved_lk=True` в токене). Некоторые эндпоинты могут требовать специфических ролей (например, "methodologist" или "admin").

## 3. Статусы Эндпоинтов

*   ✅ **Проверен:** Эндпоинт реализован, протестирован базовыми запросами и возвращает ожидаемую структуру данных с тестовым наполнением (`seed_db`).
*   ⚠️ **Требует проверки:** Эндпоинт реализован, но требует более тщательного тестирования (включая граничные случаи, обработку ошибок, корректность данных при разных сценариях).
*   ❌ **Не реализован:** Эндпоинт запланирован, но логика еще не написана.
*   ⏳ **В разработке:** Логика эндпоинта находится в процессе активной разработки.

---

## 4. Эндпоинты API

### 4.1. Проверка Работоспособности

*   **Эндпоинт:** `GET /health-check`
*   **Описание:** Проверяет, что модуль API запущен и отвечает.
*   **Аутентификация:** Не требуется.
*   **Параметры запроса:** Нет.
*   **Тело запроса:** Нет.
*   **Успешный ответ:**
    *   **Код:** `200 OK`
    *   **Тело:** `{"status": "ok"}`
*   **Статус:** ✅ **Проверен**

---

### 4.2. Образовательные Программы (ОП)

*   **Эндпоинт:** `GET /programs`
*   **Описание:** Получает список всех образовательных программ.
*   **Аутентификация:** Требуется (`@login_required`, `@approved_required`).
*   **Параметры запроса:** Нет.
*   **Тело запроса:** Нет.
*   **Успешный ответ:**
    *   **Код:** `200 OK`
    *   **Тело:** Массив объектов ОП.
        ```json
        [
          {
            "id": 1,
            "title": "Веб-технологии (09.03.01)",
            "code": "09.03.01",
            "profile": "Веб-технологии",
            "qualification": "Бакалавр",
            "form_of_education": "очная",
            "enrollment_year": 2024,
            "fgos_vo_id": 1,
            "created_at": "Tue, 08 Apr 2025 21:36:25 GMT", // Пример
            "updated_at": "Tue, 08 Apr 2025 21:36:25 GMT"  // Пример
            // ... другие поля EducationalProgram
          }
          // ... другие программы
        ]
        ```
*   **Ошибки:** `401 Unauthorized`, `403 Forbidden`.
*   **Статус:** ⚠️ **Требует проверки** (Зависит от корректности данных сидера).

*   **Эндпоинт:** `GET /programs/<int:program_id>`
*   **Описание:** Получает детальную информацию по одной ОП, включая связанный ФГОС, список АУП, выбранные и рекомендованные ПС.
*   **Аутентификация:** Требуется (`@login_required`, `@approved_required`).
*   **Параметры запроса:**
    *   `program_id` (int, в пути): ID запрашиваемой ОП.
*   **Тело запроса:** Нет.
*   **Успешный ответ:**
    *   **Код:** `200 OK`
    *   **Тело:** Объект с деталями ОП.
        ```json
        {
          "id": 1,
          "title": "Веб-технологии (09.03.01)",
          // ... другие поля ОП ...
          "fgos_details": {
            "id": 1,
            "number": "929",
            "date": "2017-09-19",
            "direction_code": "09.03.01",
            "direction_name": "Информатика и вычислительная техника",
            "education_level": "бакалавриат",
            "generation": "3++"
            // ... другие поля FGOS ...
          },
          "aup_list": [
            {
              "id_aup": 101,
              "num_aup": "B093011451",
              "file": "example.xlsx",
              // ... другие поля AupInfo ...
            }
          ],
          "selected_ps_list": [ // Профстандарты, ВЫБРАННЫЕ для этой ОП
            // { "id": 1, "code": "06.001", "name": "Программист" }, ...
          ],
          "recommended_ps_list": [ // Профстандарты, РЕКОМЕНДОВАННЫЕ ФГОС для этой ОП
            // { "id": 1, "code": "06.001", "name": "Программист" }, ...
          ]
        }
        ```
*   **Ошибки:** `401 Unauthorized`, `403 Forbidden`, `404 Not Found` (если ОП с таким ID нет).
*   **Статус:** ⚠️ **Требует проверки** (Зависит от корректности данных сидера и связей).

---

### 4.3. Матрица Компетенций

*   **Эндпоинт:** `GET /matrix/<int:aup_id>`
*   **Описание:** Получает все необходимые данные для отображения и редактирования матрицы компетенций для указанного АУП.
*   **Аутентификация:** Требуется (`@login_required`, `@approved_required`).
*   **Параметры запроса:**
    *   `aup_id` (int, в пути): ID запрашиваемого АУП (из таблицы `tbl_aup`).
*   **Тело запроса:** Нет.
*   **Успешный ответ:**
    *   **Код:** `200 OK`
    *   **Тело:** Сложный JSON объект, содержащий информацию об АУП, список его дисциплин, список релевантных компетенций с их ИДК и существующие связи в матрице. **См. Пример.**
        ```json
        // ПРИМЕР ответа для AUP 101 (на основе данных seed_db)
        {
          "aup_info": {
            "id_aup": 101,
            "num_aup": "B093011451",
            "file": "example.xlsx",
            "base": "11 классов",
            "id_faculty": 1,
            "id_rop": 1,
            "type_educ": "Высшее",
            "qualification": "Бакалавр",
            "type_standard": "ФГОС 3++",
            "id_department": 1,
            "period_educ": "4 года",
            "id_degree": 1,
            "id_form": 1,
            "years": 4,
            "months": 0,
            "id_spec": 1,
            "year_beg": 2024,
            "year_end": 2028,
            "is_actual": true
            // ... возможно, другие поля из AupInfo без связей
          },
          "disciplines": [ // Отсортировано по семестру, затем по названию
            {
              "aup_data_id": 502,
              "discipline_id": 1002,
              "title": "Базы данных",
              "semester": 1
            },
             {
              "aup_data_id": 503,
              "discipline_id": 1003,
              "title": "История России",
              "semester": 1
            },
            {
              "aup_data_id": 501,
              "discipline_id": 1001,
              "title": "Основы программирования",
              "semester": 1
            }
          ],
          "competencies": [ // Отсортировано по типу (ОПК, ПК, УК), затем по коду
            {
              "competency_type_id": 2,
              "fgos_vo_id": 1, // Должно быть заполнено
              "based_on_labor_function_id": null,
              "code": "ОПК-7",
              "name": "Способен участвовать в настройке и наладке программно-аппаратных комплексов",
              "description": null,
              "id": 107,
              "created_at": "...",
              "updated_at": "...",
              "type_code": "ОПК",
              "indicators": [ // Отсортировано по коду
                {
                  "id": 170,
                  "code": "ИОПК-7.1",
                  "formulation": "Знает основные языки программирования...",
                  "source": "ОП Веб-технологии"
                }
              ]
            },
            {
              "competency_type_id": 3,
              "fgos_vo_id": null,
              "based_on_labor_function_id": null,
              "code": "ПК-1",
              "name": "Способен выполнять работы по созданию (модификации) и сопровождению ИС...",
              "description": null,
              "id": 201,
              "created_at": "...",
              "updated_at": "...",
              "type_code": "ПК",
              "indicators": [
                {
                  "id": 210,
                  "code": "ИПК-1.1",
                  "formulation": "Знает: методологию и технологии проектирования...",
                  "source": "ОП Веб-технологии / ПС 06.015"
                }
              ]
            },
            {
              "competency_type_id": 1,
              "fgos_vo_id": 1, // Должно быть заполнено
              "based_on_labor_function_id": null,
              "code": "УК-1",
              "name": "Способен осуществлять поиск, критический анализ и синтез информации, применять системный подход для решения поставленных задач",
              "description": null,
              "id": 1,
              "created_at": "...",
              "updated_at": "...",
              "type_code": "УК",
              "indicators": [
                {
                  "id": 10,
                  "code": "ИУК-1.1",
                  "formulation": "Анализирует задачу, выделяя ее базовые составляющие",
                  "source": "Распоряжение 505-Р / ОП Веб-технологии"
                },
                {
                  "id": 11,
                  "code": "ИУК-1.2",
                  "formulation": "Осуществляет поиск, критически оценивает, обобщает...",
                  "source": "Распоряжение 505-Р / ОП Веб-технологии"
                },
                {
                  "id": 12,
                  "code": "ИУК-1.3",
                  "formulation": "Рассматривает и предлагает рациональные варианты...",
                  "source": "Распоряжение 505-Р / ОП Веб-технологии"
                }
              ]
            },
            {
              "competency_type_id": 1,
              "fgos_vo_id": 1, // Должно быть заполнено
              "based_on_labor_function_id": null,
              "code": "УК-5",
              "name": "Способен воспринимать межкультурное разнообразие общества...",
              "description": null,
              "id": 5,
              "created_at": "...",
              "updated_at": "...",
              "type_code": "УК",
              "indicators": [
                {
                  "id": 50,
                  "code": "ИУК-5.1",
                  "formulation": "Анализирует и интерпретирует события...",
                  "source": "Распоряжение 505-Р / ОП Веб-технологии"
                }
              ]
            }
          ],
          "links": [ // Существующие связи
            { "aup_data_id": 501, "indicator_id": 10 },
            { "aup_data_id": 501, "indicator_id": 11 },
            { "aup_data_id": 501, "indicator_id": 12 },
            { "aup_data_id": 501, "indicator_id": 170 },
            { "aup_data_id": 503, "indicator_id": 50 },
            { "aup_data_id": 502, "indicator_id": 210 }
          ],
          "suggestions": [] // Заглушка для NLP
        }
        ```
*   **Ошибки:** `401 Unauthorized`, `403 Forbidden`, `404 Not Found` (если АУП не найден или не связан с ОП).
*   **Статус:** ✅ **Проверен** (Базовая работоспособность и структура ответа подтверждена `curl`, корректность данных и фильтрация ПК требует дополнительной верификации).

*   **Эндпоинт:** `POST /matrix/link`
*   **Описание:** Создает новую связь между дисциплиной (AupData) и индикатором (Indicator) в матрице.
*   **Аутентификация:** Требуется (`@login_required`, `@approved_required`).
*   **Параметры запроса:** Нет.
*   **Тело запроса (JSON):**
    ```json
    {
      "aup_data_id": 502, // ID из AupData
      "indicator_id": 10  // ID из Indicator
    }
    ```
*   **Успешный ответ:**
    *   **Код:** `201 Created`
    *   **Тело:** `{"message": "Связь успешно создана"}`
*   **Ошибки:**
    *   `400 Bad Request`: Отсутствуют поля, неверные ID, ошибка БД.
    *   `401 Unauthorized`, `403 Forbidden`.
*   **Статус:** ⚠️ **Требует проверки** (Реализовано, но нужно протестировать создание, обработку ошибок).

*   **Эндпоинт:** `DELETE /matrix/link`
*   **Описание:** Удаляет связь между дисциплиной (AupData) и индикатором (Indicator) в матрице.
*   **Аутентификация:** Требуется (`@login_required`, `@approved_required`).
*   **Параметры запроса:** Нет.
*   **Тело запроса (JSON):**
    ```json
    {
      "aup_data_id": 501,
      "indicator_id": 10
    }
    ```
*   **Успешный ответ:**
    *   **Код:** `200 OK` (или `204 No Content`)
    *   **Тело:** `{"message": "Связь успешно удалена (или не существовала)"}` (для 200) или пустое тело (для 204).
*   **Ошибки:**
    *   `400 Bad Request`: Отсутствуют поля, неверные ID, ошибка БД.
    *   `401 Unauthorized`, `403 Forbidden`.
*   **Статус:** ⚠️ **Требует проверки** (Реализовано, но нужно протестировать удаление существующей/несуществующей связи, обработку ошибок).

---

### 4.4. Компетенции и Индикаторы

*   **Эндпоинт:** `POST /competencies`
*   **Описание:** Создание новой компетенции.
*   **Аутентификация:** Требуется (`@login_required`, `@approved_required`).
*   **Параметры запроса:** Нет.
*   **Тело запроса (JSON):**
    ```json
    {
      "type_code": "ПК",
      "code": "ПК-Тест",
      "name": "Тестовая профессиональная компетенция",
      "description": "Дополнительное описание (опц.)",
      "fgos_vo_id": null, // или ID ФГОС для УК/ОПК
      "based_on_labor_function_id": null // или ID ТФ
    }
    ```
*   **Успешный ответ:**
    *   **Код:** `201 Created`
    *   **Тело:** Объект созданной компетенции (включая присвоенный `id`).
*   **Ошибки:** `400 Bad Request`, `401 Unauthorized`, `403 Forbidden`.
*   **Статус:** ⚠️ **Требует проверки** (Базовая логика есть, нужна валидация и проверка связей).

*   **Эндпоинт:** `POST /indicators`
*   **Описание:** Создание нового индикатора для существующей компетенции.
*   **Аутентификация:** Требуется (`@login_required`, `@approved_required`).
*   **Параметры запроса:** Нет.
*   **Тело запроса (JSON):**
    ```json
    {
      "competency_id": 201, // ID существующей компетенции
      "code": "ИПК-Тест.1",
      "formulation": "Формулировка тестового индикатора",
      "source": "Тестовый источник" // Опционально
      // "labor_function_ids": [] // Опционально, для связи с ТФ ПС
    }
    ```
*   **Успешный ответ:**
    *   **Код:** `201 Created`
    *   **Тело:** Объект созданного индикатора (включая присвоенный `id`).
*   **Ошибки:** `400 Bad Request`, `401 Unauthorized`, `403 Forbidden`, `404 Not Found` (если `competency_id` не найден).
*   **Статус:** ⚠️ **Требует проверки** (Базовая логика есть, нужна валидация и проверка связей).

*   **Эндпоинты:**
    *   `GET /competencies`
    *   `GET /competencies/<int:id>`
    *   `PATCH /competencies/<int:id>`
    *   `DELETE /competencies/<int:id>`
    *   `GET /indicators`
    *   `GET /indicators/<int:id>`
    *   `PATCH /indicators/<int:id>`
    *   `DELETE /indicators/<int:id>`
*   **Описание:** Стандартные CRUD операции для компетенций и индикаторов.
*   **Статус:** ❌ **Не реализован** (Запланировано после MVP).

---

### 4.5. Профессиональные Стандарты (ПС)

*   **Эндпоинт:** `POST /profstandards/upload`
*   **Описание:** Загрузка файла ПС (HTML/Markdown), базовый парсинг и сохранение основной информации (код, имя, markdown) в БД.
*   **Аутентификация:** Требуется (`@login_required`, `@approved_required`).
*   **Параметры запроса:** Нет.
*   **Тело запроса:** `multipart/form-data` с полем `file`, содержащим файл ПС.
*   **Успешный ответ:**
    *   **Код:** `201 Created`
    *   **Тело:**
        ```json
        {
          "success": true,
          "prof_standard_id": 5, // ID созданного/обновленного ПС
          "code": "06.001",
          "name": "Программист"
        }
        ```
*   **Ошибки:** `400 Bad Request` (нет файла, ошибка парсинга), `401 Unauthorized`, `403 Forbidden`, `500 Internal Server Error` (ошибка БД).
*   **Статус:** ⚠️ **Требует проверки** (Базовая реализация парсинга и сохранения есть, но нужна проверка на разных файлах и доработка для парсинга структуры).

*   **Эндпоинты:**
    *   `GET /profstandards`
    *   `GET /profstandards/<code>` (или `<id>`)
*   **Описание:** Получение списка ПС и детальной информации (включая структуру ОТФ/ТФ).
*   **Статус:** ❌ **Не реализован** (Запланировано после доработки парсера).

---

## 5. Замечания для Фронтенд Разработки (Vue 3)

*   Используйте `axios` или аналогичную библиотеку для HTTP-запросов.
*   Настройте перехватчик (`interceptor`) для добавления `Authorization: Bearer <token>` ко всем защищенным запросам.
*   Настройте перехватчик для обработки ошибок `401 Unauthorized` (например, перенаправление на логин или обновление токена через `/api/auth/refresh`).
*   Используйте `Pinia` для управления состоянием: хранение токенов, данных пользователя, выбранного АУП, данных матрицы, статусов загрузки и ошибок.
*   Структура ответа `GET /matrix/<aup_id>` содержит все необходимое для рендеринга таблицы матрицы. `links` содержит массив пар `{aup_data_id, indicator_id}` для определения состояния чекбоксов.
*   При изменении чекбокса отправляйте `POST` или `DELETE` на `/matrix/link` с соответствующими `aup_data_id` и `indicator_id`. Обновляйте массив `links` в сторе Pinia после успешного ответа.
*   Реализуйте индикаторы загрузки и обработку ошибок API для улучшения UX.

Этот документ будет обновляться по мере реализации и проверки новых эндпоинтов.