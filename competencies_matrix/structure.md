# Структура Проекта: maps_backend (с фокусом на модуль competencies_matrix)

**Версия документа:** 1.2
**Дата:** 11 мая 2025

## Глоссарий Сокращений

### Используемые в данном документе (`structure.md`)

                               ## 4. Ключевые Аспекты Архитектуры и Взаимодействия

*   **Монолит с Модулями (Blueprints):** Приложение построено как единый Flask-проект, разделенный на логические модули с помощью Blueprints. `competencies_matrix` является одним из таких модулей.
*   **Единая База Данных:** Все модули работают с одной базой данных MySQL. Модели SQLAlchemy определены в соответствующих модулях (`competencies_matrix/models.py`, `maps/models.py` и т.д.).
*   **SQLAlchemy ORM + Alembic:** Доступ к данным осуществляется через ORM, структура БД управляется миграциями Alembic.
*   **REST API + JWT:** Взаимодействие с фронтендом через REST API, защищенное JWT-токенами, управляемыми модулем `auth`.
*   **Парсеры PDF/DOCX/HTML:** Специализированные парсеры для извлечения структурированных данных из документов ПС и ФГОС ВО.
*   **Кэширование:** Система кэширования через `utils/cache.py` для повышения производительности API.
*   **Логирование:** Централизованная система логирования через `utils/logging.py` для отслеживания ошибок и активности. 

| Сокращение | Расшифровка                                     | Описание                                                                                                        |
| :--------- | :----------------------------------------------- | :-------------------------------------------------------------------------------------------------------------- |
| АУП (AUP)        | Академический Учебный План                     | Документ, определяющий перечень, трудоемкость, последовательность и распределение дисциплин по периодам обучения. |
| БД         | База Данных                                      | Организованная структура для хранения и управления данными (в данном проекте - MySQL).                         |
| ИДК        | Индикатор Достижения Компетенции                 | Конкретное, наблюдаемое действие/результат, подтверждающий освоение части компетенции.                            |
| ИПК        | Индикатор Достижения Профессиональной Компетенции | ИДК, относящийся к Профессиональной Компетенции (ПК).                                                            |
| ИС         | Информационная Система                           | Система для хранения, обработки, поиска и выдачи информации.                                                    |
| ИТ         | Информационные Технологии                        | Технологии, связанные с созданием, обработкой, хранением и передачей информации.                               |
| ЛК         | Личный Кабинет                                   | Информационная система вуза для взаимодействия участников образовательного процесса.                             |
| NLP        | Natural Language Processing                      | Обработка Естественного Языка, технологии анализа и обработки человеческого языка.                               |
| ОП         | Образовательная Программа                        | Комплекс характеристик образования (цели, результаты, содержание, технологии).                                 |
| ОПК        | Общепрофессиональная Компетенция                 | Компетенция, общая для укрупненной группы направлений/специальностей (из ФГОС ВО).                              |
| ОТФ        | Обобщенная Трудовая Функция                      | Крупный блок трудовых действий в рамках Профессионального Стандарта (ПС).                                       |
| ПК         | Профессиональная Компетенция                     | Компетенция, связанная с конкретной проф. деятельностью (формируется на основе ПС).                              |
| ПО         | Программное Обеспечение                          | Комплекс программ для выполнения определенных задач.                                                           |
| ПС         | Профессиональный Стандарт                        | Документ, описывающий требования к квалификации для вида проф. деятельности.                                     |
| РПД        | Рабочая Программа Дисциплины                     | Документ, детализирующий содержание, методы и оценку по конкретной дисциплине.                                 |
| ТД         | Трудовое Действие                                | Элементарное действие в рамках Трудовой Функции (ТФ) Профессионального Стандарта (ПС).                           |
| ТЗ         | Техническое Задание                              | Документ, описывающий требования к разрабатываемой системе.                                                      |
| ТФ         | Трудовая Функция                                 | Совокупность трудовых действий в рамках Обобщенной Трудовой Функции (ОТФ) Профессионального Стандарта (ПС).     |
| УК         | Универсальная Компетенция                        | Компетенция, общая для всех направлений на уровне образования (из ФГОС ВО).                                     |
| ФГОС ВО    | Федеральный Гос. Образовательный Стандарт ВО     | Документ, устанавливающий обязательные требования к высшему образованию.                                        |

### Используемые в проекте в целом (могут не встречаться в `structure.md`)

| Сокращение | Расшифровка                             | Описание                                                                                       |
| :--------- | :-------------------------------------- | :--------------------------------------------------------------------------------------------- |
| ВО         | Высшее Образование                      | Уровень профессионального образования.                                                          |
| ГИА        | Государственная Итоговая Аттестация     | Итоговая проверка освоения образовательной программы.                                           |
| ГОСТ       | Государственный стандарт                | Нормативный документ, устанавливающий требования к продукции, процессам или услугам.          |
| ИОПК       | Индикатор ОПК                           | ИДК, относящийся к ОПК.                                                                       |
| ИУК        | Индикатор УК                            | ИДК, относящийся к УК.                                                                        |
| НЗ         | Необходимые Знания                      | Элемент структуры Профессионального Стандарта (ПС), связанный с ТФ.                            |
| НУ         | Необходимые Умения                      | Элемент структуры Профессионального Стандарта (ПС), связанный с ТФ.                            |
| ОПОП       | Основная Проф. Образовательная Программа | Синоним ОП в нормативных документах.                                                         |
| ПД         | Профессиональная Деятельность           | Область трудовой активности.                                                                  |
| ПООП       | Примерная ООП                           | Рекомендательный документ, помогающий разрабатывать ОП.                                          |
| РПП        | Рабочая Программа Практики              | Документ, детализирующий содержание и организацию практики.                                     |
| ФОС        | Фонд Оценочных Средств                  | Комплект материалов для оценки освоения компетенций/ИДК.                                       |
| ЭБС        | Электронно-Библиотечная Система         | Система доступа к электронным версиям учебных изданий.                                        |
| ЭИОС       | Электронная Инф.-Образовательная Среда | Совокупность ИТ-ресурсов и технологий, используемых в образовательном процессе.                 |

---

## 1. Корневая Директория Проекта (`maps_backend/`)

```
maps_backend/
├── administration/       # Модуль администрирования (Flask-Admin)
├── auth/                 # Модуль аутентификации и авторизации (JWT, ЛК)
├── cabinet/              # Модуль "Академический кабинет" (оценки, задания, группы)
├── cli_commands/         # Модуль для пользовательских CLI команд (Flask CLI)
├── competencies/         # Виртуальное окружение для локальной разработки
├── competencies_matrix/  # <<<--- КЛЮЧЕВОЙ МОДУЛЬ: Матрицы Компетенций
├── maps/                 # Модуль "Карты Дисциплин" (AUP, Disciplines)
├── migrations/           # Директория Alembic для миграций схемы БД
├── static/               # Общие статические файлы (например, шаблоны DOCX)
├── unification/          # Модуль унификации дисциплин
├── utils/                # Общие утилиты приложения
│
├── .env                  # Локальные переменные окружения (не хранится в репозитории)
├── .env.example          # Пример файла .env (хранится в репозитории)
├── app.py                # Главный файл приложения Flask (фабрика приложения, регистрация Blueprints)
├── config.py             # Конфигурация приложения (подключение к БД, секретные ключи)
├── db_structure.md       # Документация о структуре базы данных
├── Dockerfile            # Файл для сборки Docker-образа
├── gunicorn_config.py    # Конфигурация Gunicorn (для production)
├── proper_schema.md      # Документация с описанием схемы БД
├── read_excel_header.py  # Утилита для чтения заголовков Excel-файлов
├── requirements.txt      # Список зависимостей Python
├── take_from_bd.py       # Утилита для извлечения данных из БД
├── test.py               # Тестовые скрипты
└── *.md                  # Другие файлы документации (README и т.д.)
```

## 2. Описание Ключевых Модулей и Компонентов

### 2.1. `competencies_matrix/` (Модуль Матрицы Компетенций)

**Назначение:** Ядро разрабатываемой системы. Отвечает за хранение, управление и предоставление данных, связанных с компетенциями, индикаторами их достижения (ИДК), образовательными программами (ОП), ФГОС ВО, профессиональными стандартами (ПС), и формирование матрицы связей "Дисциплина ↔ ИДК".

```
competencies_matrix/
│
├── __init__.py             # Инициализация Blueprint `competencies_matrix_bp` с префиксом /api/competencies.
│
├── routes.py               # Определяет API эндпоинты модуля. Ответственен за прием запросов от клиента,
│                           # вызов соответствующей бизнес-логики и возврат ответа в формате JSON.
│                           # Ключевые эндпоинты: /programs, /matrix/<aup_id>, /matrix/link, /competencies, /indicators, /profstandards/upload.
│                           # Применяет декораторы аутентификации/авторизации из `auth.logic`.
│
├── models.py               # Определяет SQLAlchemy модели для НОВЫХ таблиц БД, специфичных для этого модуля
│                           # (префикс `competencies_*`). Описывает структуру данных для ОП, ФГОС, ПС (и его элементов),
│                           # Компетенций (УК/ОПК/ПК), Индикаторов (ИУК/ИОПК/ИПК), связей ПС-ИДК, и самой матрицы (CompetencyMatrix).
│                           # Включает динамическое добавление `relationship` к модели `AupData` (из `maps.models`).
│
├── logic.py                # Содержит основную бизнес-логику модуля:
│                           # - `get_educational_programs_list()`: Получение списка ОП.
│                           # - `get_program_details()`: Получение деталей ОП (связи с ФГОС, АУП, ПС).
│                           # - `get_matrix_for_aup()`: Сбор и форматирование данных для матрицы АУП.
│                           # - `update_matrix_link()`: Создание/удаление связей в матрице.
│                           # - `create_competency()`, `create_indicator()`: Создание компетенций/индикаторов.
│                           # - `handle_prof_standard_upload_parsing()`: Оркестрация парсинга ПС и сохранения в БД.
│                           # - `parse_fgos_file()`: Оркестрация парсинга ФГОС и сохранения в БД (использует `fgos_parser.py`).
│
├── parsers.py              # Функции для парсинга исходных файлов Профессиональных Стандартов (ПС).
│                           # Ответственен за извлечение метаданных и СТРУКТУРЫ ПС (ОТФ, ТФ, ТД, НУ, НЗ) из HTML/DOCX/PDF.
│                           # Текущая реализация (`profstandard-lean.py` интегрирована сюда) может требовать ДОРАБОТКИ для полного структурного парсинга.
│
├── profstandard-lean.py    # Оригинальная версия парсера ПС (сохранена для справки, функционал перенесен в parsers.py)
│
├── external_models.py      # Внешние модели для интеграции с другими модулями (maps, auth)
│
├── fgos_parser.py          # Функции для парсинга Федеральных Государственных Образовательных Стандартов
│
├── insomnia-testing/       # Каталог с файлами для тестирования API через Insomnia
│   ├── insomnia-env.json   # Файл окружения Insomnia
│   └── insomnia-requests.json  # Коллекция запросов API для тестирования
│
├── api_documentation.md    # Документация по API эндпоинтам модуля.
├── description.md          # Общее описание модуля, его архитектуры и назначения.
├── structure.md            # (Ссылка на этот файл) Описание структуры всего проекта.
└── tasks.md                # Актуальный список задач по разработке данного модуля.
```

**Взаимодействие с другими модулями:**
*   **`maps`:** Читает данные `AupInfo`, `AupData`, `SprDiscipline` через `maps.models`.
*   **`auth`:** Использует `auth.logic` для защиты API (`@login_required`, `@approved_required`, `@admin_only`), читает `auth.models` для получения информации о пользователе/ролях.
*   **`cabinet`:** Прямого взаимодействия нет, но использует общие модели (`StudyGroups`, `Students` и т.д., если потребуется интеграция успеваемости).
*   **`cli_commands`:** Функции из `competencies_matrix.logic` могут вызываться CLI-командами (например, для парсинга ПС/ФГОС).

### 2.2. `maps/` (Модуль Карты Дисциплин)

**Назначение:** Исходный модуль, предоставляющий данные об Академических Учебных Планах (АУП), дисциплинах и их структуре. **Критически важен** для `competencies_matrix`, т.к. предоставляет список дисциплин для матрицы.

```
maps/
│
├── logic/                  # Логика обработки АУП:
│   ├── read_excel.py       # Чтение АУП из Excel (формат 1С, 2 листа). Используется `competencies_matrix` (через CLI/API).
│   ├── excel_check.py      # Валидация данных Excel. Используется `competencies_matrix` (через CLI/API).
│   ├── save_excel_data.py  # Сохранение данных Excel в БД (`tbl_aup`, `aup_data`). Включает создание ОП и связи. Используется `competencies_matrix` (через CLI/API).
│   ├── take_from_bd.py     # Получение данных из БД для карт дисциплин.
│   └── ...                 # Другие файлы логики (печать, сохранение изменений и т.д.)
│
├── models.py               # Модели SQLAlchemy для таблиц `tbl_aup`, `aup_data`, `spr_discipline`, `d_*`, `groups` и др. Активно используются `competencies_matrix`.
├── routes.py               # Основные API эндпоинты модуля `maps`.
├── routes/                 # Дополнительные/новые API эндпоинты модуля `maps`.
├── static/                 # Статические файлы для модуля карт дисциплин.
└── __init__.py             # Инициализация Blueprint.
```

### 2.3. `auth/` (Модуль Аутентификации/Авторизации)

**Назначение:** Обеспечивает вход пользователей в систему (через API ЛК), управление JWT-токенами и проверку прав доступа к API эндпоинтам.

```
auth/
│
├── cli.py                  # CLI-команды для управления пользователями и ролями (`flask user-*`, `flask role-*`).
├── documentation.md        # Документация по аутентификации и авторизации.
├── logic.py                # Функции: логин, проверка пароля, генерация/валидация JWT, декораторы `@login_required`, `@approved_required`, `@admin_only`. Используются `competencies_matrix`.
├── models.py               # Модели SQLAlchemy: `Users`, `Roles`, `user_roles_table`, `TblToken`. Используются `competencies_matrix`.
├── routes.py               # API эндпоинты: `/login`, `/refresh`, `/logout`.
└── __init__.py             # Инициализация Blueprint.
```

### 2.4. `cabinet/` (Модуль Академический Кабинет)

**Назначение:** Управление учебным процессом: расписание, оценки, задания, группы. **Для MVP `competencies_matrix` прямое взаимодействие минимально**, но модели (`StudyGroups`, `Students`, `Grades`, `Topic`) используются в общей БД и могут быть задействованы для будущего функционала (учет успеваемости по ИДК).

```
cabinet/
│
├── cabinet.py              # Основной Blueprint и роуты для заданий, оценок, групп.
├── models.py               # Модели SQLAlchemy: `DisciplineTable`, `Topics`, `StudyGroups`, `Students`, `Grades`, `GradeColumn`, `GradeType`, `Tutors`, `TutorsOrder` и др.
├── lib/                    # Вспомогательная логика.
└── utils/                  # Утилиты.
```

### 2.5. `cli_commands/` (Пользовательские CLI Команды)

**Назначение:** Предоставляет команды для управления приложением из командной строки через `flask ...`.

```
cli_commands/
│
├── db_seed.py              # `flask seed_db`: Наполнение БД тестовыми данными (включая данные для `competencies_matrix`).
├── db_unseed.py            # `flask unseed_db`: Очистка тестовых данных.
├── fgos_import.py          # `flask import-fgos <filepath>`: Импорт ФГОС из PDF (использует логику из `competencies_matrix.fgos_parser`).
├── import_aup.py           # `flask import-aup <filepath>`: Импорт АУП из Excel (использует логику из `maps.logic`).
├── parse_profstandard.py   # `flask parse-profstandard <filepath>`: Парсинг Профстандарта и сохранение в БД.
└── __init__.py
```

### 2.6. `utils/` (Общие Утилиты)

**Назначение:** Предоставляет общие утилиты, которые используются во всех модулях приложения.

```
utils/
│
├── cache.py               # Функционал кэширования для улучшения производительности API.
├── handlers.py            # Обработчики ошибок и исключений.
├── logging.py             # Настройки логирования приложения.
└── __init__.py
```

### 2.7. `migrations/` (Миграции Alembic)

**Назначение:** Управление версиями схемы базы данных. Содержит скрипты для создания, изменения и отката структуры таблиц. **Критически важно** для поддержания консистентности БД между разработчиками и на разных окружениях. Новые изменения в `*.models.py` требуют создания новой миграции (`flask db migrate`) и ее применения (`flask db upgrade`).

### 2.8. `competencies/` (Виртуальное Окружение)

**Назначение:** Виртуальное окружение Python для локальной разработки. Содержит изолированную установку зависимостей для проекта.

```
competencies/
│
├── bin/                    # Исполняемые файлы Python и установленные пакеты.
├── include/                # Заголовочные файлы C для скомпилированных Python-модулей.
├── lib/                    # Библиотеки и модули Python.
├── lib64                   # Символическая ссылка на lib/ (для 64-битных систем).
└── pyvenv.cfg              # Конфигурация виртуального окружения.
```

## 3. Ключевые Файлы в Корневой Директории

### 3.1. Конфигурационные файлы

- `config.py` - Основная конфигурация приложения, содержит настройки БД, секреты и другие параметры.
- `.env` и `.env.example` - Файлы для хранения переменных окружения (.env не хранится в репозитории).
- `gunicorn_config.py` - Настройки Gunicorn для запуска в production-среде.
- `Dockerfile` - Инструкции для сборки Docker-образа приложения.

### 3.2. Скрипты и утилиты

- `app.py` - Точка входа в приложение Flask, содержит фабрику приложения и регистрацию Blueprints.
- `read_excel_header.py` - Утилита для чтения заголовков Excel-файлов АУП.
- `take_from_bd.py` - Вспомогательный скрипт для извлечения данных из БД.
- `test.py` - Файл с тестовыми скриптами.

### 3.3. Документация

- `README.md` - Основная документация по проекту.
- `db_structure.md` - Документация о структуре базы данных.
- `proper_schema.md` - Подробное описание схемы базы данных.

### 3.4. Файлы для обработки

- `ФГОС ВО 090301_B_3_15062021.pdf` - Пример файла ФГОС для направления 09.03.01.
- `ФГОС ВО 180301_B_3_23082020.pdf` - Пример файла ФГОС для направления 18.03.01.
- `03 - 000020751 - 2024 Управление инновационной деятельностью 31.05.2024 11 46 26.xlsx` - Пример файла АУП для импорта.
- `debug_ps_list_text_ФГОС ВО 090301_B_3_15062021.txt` - Отладочный файл для парсинга.

## 4. Ключевые Аспекты Архитектуры и Взаимодействия

*   **Монолит с Модулями (Blueprints):** Приложение построено как единый Flask-проект, разделенный на логические модули с помощью Blueprints. `competencies_matrix` является одним из таких модулей.
*   **Единая База Данных:** Все модули работают с одной базой данных MySQL. Модели SQLAlchemy определены в соответствующих модулях (`competencies_matrix/models.py`, `maps/models.py` и т.д.).
*   **SQLAlchemy ORM + Alembic:** Доступ к данным осуществляется через ORM, структура БД управляется миграциями Alembic.
*   **REST API + JWT:** Взаимодействие с фронтендом через REST API, защищенное JWT-токенами, управляемыми модулем `auth`.
*   **Интеграция `competencies_matrix`:**
    *   **Чтение:** Читает `AupInfo`, `AupData`, `SprDiscipline` из `maps.models`. Читает `Users`, `Roles` из `auth.models` через `external_models.py`.
    *   **Запись:** Записывает данные в свои таблицы (`competencies_*`). **Модифицирует** `EducationalProgram` (создает) и связывает ее с `AupInfo` через `EducationalProgramAup` при импорте АУП.
    *   **Защита:** Использует декораторы из `auth.logic`.
    *   **API-Тестирование:** Предоставляет готовые коллекции запросов в директории `insomnia-testing/` для упрощения тестирования API.