# Руководство для разработчика: Модуль `competencies_matrix` (Актуальное состояние)

**Версия документа:** 1.3
**Дата:** 2025-05-23 (Обновлено)

## 1. Введение и Цель Модуля

Этот документ описывает модуль `competencies_matrix`, являющийся частью бэкенда веб-приложения "Карты Дисциплин" и расширяющий его функционал возможностями для работы с матрицами компетенций.

**Основная цель** модуля — предоставить инструменты для **создания, управления и визуализации матриц распределения компетенций для образовательных программ (ОП)** в соответствии с требованиями ФГОС ВО и Профессиональных Стандартов (ПС). Модуль фокусируется на работе с Компетенциями (УК, ОПК, ПК) и **Индикаторами их Достижения (ИДК)**.

**Ключевые задачи, решаемые модулем (в текущей реализации и ближайших планах):**

1.  **Хранение данных:** Обеспечение структуры БД для ОП, ФГОС, ПС, компетенций, ИДК и связей матрицы. *(Структура создана через миграции)*.
2.  **Управление ИДК и Компетенциями:** Предоставление API для создания, чтения, обновления и удаления (CRUD) компетенций и индикаторов. *(Реализовано)*.
    *   **Особый фокус на ПК:** Возможность формирования Профессиональных Компетенций (ПК) и их Индикаторов (ИПК) на основе **структурированных данных Профессиональных Стандартов (ПС)**.
3.  **Формирование Матрицы:** Реализация API для получения данных, необходимых для отображения матрицы (список дисциплин АУП, список ИДК, существующие связи), и для ручного управления связями "Дисциплина-ИДК". *(API чтения реализовано, API редактирования - реализовано и протестировано)*.
4.  **Обработка Документов:**
    *   **ФГОС ВО:** Парсинг PDF-файлов ФГОС ВО для извлечения метаданных, Универсальных (УК) и Общепрофессиональных (ОПК) компетенций (включая их категории), а также кодов рекомендованных ПС. Возможность предпросмотра и сохранения в БД с обработкой обновлений. *(Реализовано и улучшено)*.
    *   **Профессиональные Стандарты (ПС):** Парсинг XML-файлов ПС для извлечения полной структурированной информации (метаданные, ОТФ, ТФ, Трудовые Действия, Необходимые Умения, Необходимые Знания). Возможность предпросмотра и сохранения в БД. *(Переработано для XML, реализовано)*.
5.  **Интеграция:** Взаимодействие с существующими данными модуля `maps` ("Карты Дисциплин") и использование общей системы аутентификации (`auth`). *(Интеграция чтения данных из `maps` реализована, используется внешняя БД КД)*.

Модуль является логически обособленной частью, но интегрирован в основной бэкенд.

## 2. Архитектурное Размещение

Модуль `competencies_matrix` реализован как **Flask Blueprint** (`competencies_matrix_bp`) с префиксом `/api/competencies`. Регистрация Blueprint происходит в основном файле приложения `app.py`.

**Расположение в структуре проекта:**

maps_backend/
├── ... (другие модули: administration, auth, cabinet, maps) ...
├── competencies_matrix/   # <<<--- НАШ МОДУЛЬ
│   ├── __init__.py        # Регистрация Blueprint, настройка обработчиков ошибок
│   ├── routes.py          # API эндпоинты
│   ├── models.py          # SQLAlchemy модели для НОВЫХ таблиц (competencies_*)
│   ├── logic.py           # Функции бизнес-логики
│   ├── parsers.py         # Логика парсинга ПС (XML)
│   ├── fgos_parser.py     # Логика парсинга ФГОС ВО (PDF)
│   ├── external_models.py # Модели для чтения из внешней БД "Карт Дисциплин"
│   ├── utils/             # НОВОЕ: Директория для общих утилит
│   │   └── parsing_utils.py # НОВОЕ: Общие утилиты для парсинга (например, `parse_date_string`)
│   ├── schemas.py         # (Опц.) Схемы Pydantic/Marshmallow
│   └── ... (файлы документации: api_documentation.md, description.md, tasks.md)
├── ... (общие файлы: app.py, config.py, migrations) ...

Модуль использует **общую базу данных MySQL**, объект `db` и модели из `maps.models`, конфигурацию из `config.py` и модуль аутентификации `auth`.

## 3. Структура Модуля `competencies_matrix`

*   `__init__.py`:** Создает `Blueprint`, задает префикс `/api/competencies`, регистрирует базовые обработчики ошибок 404/500. Импортирует `routes.py`.
*   `routes.py`:** Определяет API эндпоинты. Текущие реализованные и **проверенные на базовую работоспособность** эндпоинты включают:
    *   `GET /programs`: Получение списка ОП.
    *   `GET /programs/<program_id>`: Получение деталей ОП.
    *   `GET /external/aups`: Поиск АУП во внешней БД КД.
    *   `GET /external/aups/<aup_id>/disciplines`: Получение дисциплин АУП из внешней БД КД.
    *   `GET /matrix/<aup_num>`: Получение данных для построения матрицы АУП.
    *   `POST /matrix/link`: Создание связи в матрице.
    *   `DELETE /matrix/link`: Удаление связи в матрице.
    *   `GET /competencies`: Получение списка всех компетенций.
    *   `GET /competencies/<comp_id>`: Получение деталей компетенции.
    *   `POST /competencies`: Создание новой компетенции (ПК).
    *   `PATCH /competencies/<comp_id>`: Обновление компетенции.
    *   `DELETE /competencies/<comp_id>`: Удаление компетенции.
    *   `GET /indicators`: Получение списка всех индикаторов.
    *   `GET /indicators/<ind_id>`: Получение деталей индикатора.
    *   `POST /indicators`: Создание нового индикатора.
    *   `PATCH /indicators/<ind_id>`: Обновление индикатора.
    *   `DELETE /indicators/<ind_id>`: Удаление индикатора.
    *   `GET /fgos`: Получение списка ФГОС.
    *   `GET /fgos/<fgos_id>`: Получение деталей ФГОС.
    *   `POST /fgos/upload`: Загрузка и парсинг PDF ФГОС (предпросмотр).
    *   `POST /fgos/save`: Сохранение ФГОС в БД.
    *   `DELETE /fgos/<fgos_id>`: Удаление ФГОС.
    *   `GET /profstandards`: Получение списка ПС.
    *   `GET /profstandards/<ps_id>`: Получение деталей ПС (включая структуру).
    *   `POST /profstandards/parse-preview`: Загрузка и парсинг XML ПС (предпросмотр).
    *   `POST /profstandards/save`: Сохранение ПС в БД.
    *   `DELETE /profstandards/<ps_id>`: Удаление ПС.
    Все эндпоинты (кроме health-check) защищены декораторами аутентификации/авторизации. Запросы **делегируются** функциям из `logic.py`.
*   `models.py`:** Определяет SQLAlchemy модели для **новых таблиц** (префикс `competencies_`). Включает модели для ФГОС, ОП, ПС (включая ОТФ, ТФ, ТД, НУ, НЗ), Компетенций, Индикаторов, и связей между ними. Содержит **`category_name`** для компетенций. Включает динамическое добавление `relationship` к модели `AupData` из `maps.models` для связи с матрицей.
*   `logic.py`:** Содержит функции бизнес-логики. Отвечает за взаимодействие с БД, обработку данных, вызов парсеров. Функции: получение/сохранение/удаление ОП, ФГОС, ПС, Компетенций, Индикаторов, управление связями матрицы. Использует `parse_date_string` из `utils.parsing_utils`.
*   `parsers.py`:** Содержит функции для парсинга XML-файлов Профессиональных Стандартов (ПС). Извлекает метаданные и полную иерархическую структуру ПС.
*   `fgos_parser.py`:** Содержит функции для парсинга PDF-файлов Федеральных Государственных Образовательных Стандартов (ФГОС ВО). Извлекает метаданные, УК/ОПК (включая категории) и коды рекомендованных ПС.
*   `external_models.py`:** Определяет SQLAlchemy модели для **чтения** данных из внешней БД "Карт Дисциплин" (`tbl_aup`, `aup_data`, `spr_discipline` и др.).
*   `utils/parsing_utils.py`:** **НОВЫЙ файл.** Содержит общие вспомогательные функции для парсинга, такие как `parse_date_string`, используемые как `fgos_parser.py`, так и `parsers.py` для обеспечения DRY.
*   `schemas.py`, `utils.py`:** Пока не содержат значимой логики.

## 4. Ключевые Сущности и Поток Данных (Актуальное Состояние)

Система оперирует сущностями, описанными ранее.

**Текущий реализованный поток для отображения матрицы (`GET /matrix/<aup_num>`):**

1.  `routes.py` получает запрос с `aup_num`.
2.  Вызывается `logic.get_matrix_for_aup(aup_num)`.
3.  Функция запрашивает из БД (`db.session.query`):
    *   `AupInfo` (из локальной `maps.models`), связанную `EducationalProgram` и `FgosVo`.
    *   Список `AupData` для `aup_id` (из внешней `external_models.py` через `get_external_aup_disciplines`).
    *   Список УК/ОПК (связанных с ФГОС ОП) и ПК (связанных с ОП) с их индикаторами.
    *   Существующие связи из `CompetencyMatrix`.
4.  `logic.py` форматирует полученные данные в структуру JSON.
5.  `routes.py` возвращает JSON клиенту.

**Новый реализованный поток для формирования ПК/ИПК из ПС (через UI):**

1.  **Загрузка ПС:** Методист на странице "Профстандарты" загружает XML-файл.
    *   `POST /profstandards/parse-preview` получает файл.
    *   `handle_prof_standard_upload_parsing()` вызывает `parse_prof_standard()` (который вызывает `parse_prof_standard_xml()`).
    *   `parse_prof_standard_xml()` извлекает полную структуру ПС (метаданные, ОТФ, ТФ, ТД, НУ, НЗ) и возвращает ее.
    *   Бэкенд также проверяет, существует ли ПС с таким кодом в БД.
    *   Фронтенд отображает полученные данные в `ProfStandardUploadPreviewModal.vue` для предпросмотра (с сравнением, если ПС уже существует).
2.  **Сохранение ПС:** Методист подтверждает сохранение.
    *   `POST /profstandards/save` получает подтвержденные данные.
    *   `save_prof_standard_data()` сохраняет или обновляет ПС и всю его иерархическую структуру (ОТФ, ТФ, ТД, НУ, НЗ) в локальную БД.
3.  **Формирование ПК из ТФ:** На странице "Профстандарты" или в модальном окне `ProfStandardDetailsModal.vue` пользователь выбирает Трудовую Функцию (ТФ) из загруженного ПС и нажимает "Создать ПК из этой ТФ".
    *   Фронтенд открывает `CreateOrEditPKIPKFromPSModal.vue`, передавая в него полный объект выбранной ТФ.
    *   В этом модальном окне методист:
        *   Редактирует предложенные код и наименование ПК (на основе ТФ).
        *   Выбирает, к каким ОПОП будет привязана эта ПК.
        *   Нажимает "Сохранить ПК".
    *   `POST /competencies` получает данные, `create_competency()` сохраняет ПК, связывая ее с выбранной ТФ (через `based_on_labor_function_id`) и выбранными ОПОП.
4.  **Формирование ИПК из ТД/НУ/НЗ:** В том же модальном окне или на отдельной форме, для созданной/выбранной ПК методист:
    *   Выбирает одно или несколько Трудовых Действий, Необходимых Умений, Необходимых Знаний из ТФ (которая является основой для ПК).
    *   Система предлагает формулировку ИПК (конкатенация выбранных элементов) и код.
    *   Методист редактирует/подтверждает.
    *   Нажимает "Сохранить ИПК".
    *   `POST /indicators` получает данные, `create_indicator()` сохраняет ИПК, связывая ее с родительской ПК.

## 5. Интеграция с Другими Модулями/Системами

*   **`maps`:** Активно **читает** данные `AupInfo`, `AupData`, `SprDiscipline` через `external_models.py` для доступа к внешней БД КД. Запись в `maps` не производится.
*   **`auth`:** Используется для защиты API (`@login_required`, `@approved_required`, `@admin_only`).
*   **`cabinet`:** **Нет** прямой интеграции на данный момент.
*   **ЛК:** Только через `auth` для аутентификации.
*   **NLP:** **Нет** интеграции на данный момент (функции возвращают пустые/заглушечные данные).

## 6. Управление Схемой и Данными

*   **Схема БД:** Определяется моделями (`*.models.py`) и управляется через **Alembic**. Актуальная структура **соответствует** последней примененной миграции (включая `category_name` в `Competency` и полную структуру ПС).
*   **Создание/Обновление Схемы:** Выполняется **только** через `flask db upgrade`.
*   **Наполнение Данными:** Выполняется через команду `flask seed_db`. **Команда реализована, использует `merge`, включает тестовые данные для MVP, но требует финальной верификации корректности вставленных данных**.

## 7. Текущий Статус и Ближайшие Задачи (Фокус MVP)

*   **Статус:**
    *   Структура модуля создана, интегрирована в `app.py`.
    *   Миграции Alembic применены, схема БД актуальна.
    *   Модели (`models.py`) синхронизированы с миграциями, `category_name` добавлено.
    *   `_parse_date_string` вынесен в `utils/parsing_utils.py` (DRY).
    *   Команда `seed_db` реализована, использует `merge`, включает тестовые данные.
    *   API `GET /matrix/<aup_num>` реализован, возвращает данные.
    *   API для ручного создания/удаления связей в матрице (`POST/DELETE /matrix/link`) реализованы.
    *   API для CRUD компетенций/индикаторов **реализованы**.
    *   **API для загрузки, предпросмотра и сохранения ФГОС из PDF (с УК/ОПК/категориями и рекомендованными ПС) реализован**.
    *   **API для загрузки, предпросмотра и сохранения ПС из XML (с полной структурой) реализован**.
    *   `ProfStandardDetailsModal.vue` отображает структуру ПС.
    *   `CreateOrEditPKIPKFromPSModal.vue` отображает детали ТФ и является заготовкой для создания ПК/ИПК.
*   **Ближайшие Задачи (для завершения MVP):**
    1.  **Доработка UI `CreateOrEditPKIPKFromPSModal.vue`:**
        *   [ ] Реализовать Шаг 2: Форма создания ПК (с предзаполнением из ТФ, привязкой к ОПОП, валидацией и вызовом `competenciesStore.createCompetency`).
        *   [ ] Реализовать Шаг 3: Форма создания ИПК (с выбором ТД/НУ/НЗ, предзаполнением формулировки, валидацией и вызовом `competenciesStore.createIndicator`).
        *   [ ] Продумать и реализовать UX для редактирования существующих ПК и ИПК через это же модальное окно.
    2.  **Доработка `CompetenciesIndicatorsView.vue`:**
        *   [ ] Кнопки "Добавить ПК" и "Добавить Индикатор" должны открывать `CreateOrEditPKIPKFromPSModal.vue` с соответствующим `mode`.
        *   [ ] Добавить кнопки редактирования и удаления для ПК и ИПК.
    3.  **Верификация Данных:**
        *   [ ] Тщательно проверить корректность данных, извлекаемых из PDF ФГОС и XML ПС, и их сохранения в БД.
        *   [ ] Проверить все CRUD операции для компетенций и индикаторов через UI.
    4.  **Улучшение Отображения в `FgosPreviewModal.vue` и `ProfStandardDetailsModal.vue`:**
        *   [ ] Отображение "старый текст -> новый текст" для всех изменяемых полей при обновлении.
        *   [ ] Улучшение UI для списков рекомендованных ПС в ФГОС (показывать названия, если ПС загружен).
    5.  **Фильтрация ПК в Матрице:**
        *   [ ] Доработать `get_matrix_for_aup` в `logic.py` для более точной фильтрации ПК: показывать только те ПК, которые привязаны к выбранной ОП (или к ПС, выбранным для этой ОП).
            *   [ ] Добавить возможность указать, что связь "ТФ - Дисциплина" - обязательна, на основании которого отображать или не отображать эти данные во фронт-енде.

---

## 8. Задачи Backlog (После MVP / Для ВКР - в перспективе)

*   [ ] **NLP Интеграция:** Подключить NLP для предложений связей и формулировок (для ИДК, связей матрицы).
*   [ ] **Связь ИПК с элементами ПС:** Реализовать сохранение и отображение явных связей между ИПК и конкретными ТД/НУ/НЗ в таблице `IndicatorPsLink`.
*   [ ] **Учет Успеваемости по ИДК:** Связать оценки с ИДК.
*   [ ] **Отчеты:** Генерация матрицы в DOCX и других отчетов.
*   [ ] **Локальное Кэширование/Синхронизация АУП.**
*   [ ] **Тестирование (Unit/Integration).**
*   [ ] **Документация API (более детальная).**
*   [ ] **Оптимизация производительности.**
*   [ ] **Улучшение UI/UX.**