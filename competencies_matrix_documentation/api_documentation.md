# API Документация: Модуль Матрицы Компетенций (`competencies_matrix`)

**Версия API:** 0.1.0 (MVP)
**Дата:** 2025-05-11 (Обновлено)
**Базовый URL:** `/api/competencies`

## 1. Введение

Модуль `competencies_matrix` предоставляет API для управления образовательными программами (ОП), компетенциями, индикаторами их достижения (ИДК), ФГОС ВО, Профессиональными стандартами (ПС) и формирования матриц распределения компетенций по дисциплинам академических учебных планов (АУП).

API взаимодействует как с локальной базой данных модуля, так и с внешней базой данных АУП (через соответствующие эндпоинты).

## 2. Аутентификация

Все эндпоинты (кроме `/health-check`) требуют аутентификации через **Bearer Token** в заголовке `Authorization`. Токен получается через `/api/auth/login`. Большинство эндпоинтов требуют одобренной учетной записи (`approved_lk=True`). Некоторые эндпоинты (отмечены как `(Admin only)`) требуют роли "admin".

**Пример заголовка:** `Authorization: Bearer <YOUR_ACCESS_TOKEN>`

## 3. Статусы Эндпоинтов

*   ✅ **Проверен:** Реализован и протестирован базовыми запросами.
*   ⚠️ **Требует проверки:** Реализован, но требует дополнительного тестирования (граничные случаи, ошибки, корректность данных).
*   ❌ **Не реализован:** Запланирован, но логика отсутствует.
*   ⏳ **В разработке:** Логика в процессе активной разработки.

## 4. Общие Коды Ошибок

*   `401 Unauthorized`: Отсутствует или неверный токен аутентификации.
*   `403 Forbidden`: Недостаточно прав для выполнения операции (не одобрена учетная запись, неверная роль).
*   `404 Not Found`: Запрашиваемый ресурс не найден.
*   `400 Bad Request`: Неверный формат запроса, отсутствуют обязательные поля, ошибка валидации данных.
*   `415 Unsupported Media Type`: Неверный формат файла при загрузке.
*   `500 Internal Server Error`: Внутренняя ошибка сервера.
*   `501 Not Implemented`: Запрошенная функция не реализована.

## 5. Эндпоинты API

### 5.1. Проверка Работоспособности

*   **Эндпоинт:** `GET /health-check`
*   **Описание:** Проверяет доступность API модуля.
*   **Аутентификация:** Не требуется.
*   **Статус:** **Не существует, возвращает 404**

### 5.2. Образовательные Программы (ОП)

*   **Эндпоинт:** `GET /programs`
*   **Описание:** Получает список всех образовательных программ из локальной БД.
*   **Аутентификация:** Требуется.
*   **Статус:** ✅ **Проверен**

*   **Эндпоинт:** `GET /programs/<int:program_id>`
*   **Описание:** Получает детальную информацию по одной ОП (связанный ФГОС, АУПы из локальной БД, выбранные ПС).
*   **Аутентификация:** Требуется.
*   **Параметры пути:** `program_id` (int)
*   **Статус:** ✅ **Проверен**

### 5.3. Матрица Компетенций

*   **Эндпоинт:** `GET /matrix/<string:aup_num>`
*   **Описание:** Получает все необходимые данные для отображения и редактирования матрицы компетенций для указанного АУП по его номеру. Включает информацию об АУП (из локальной или внешней БД), список дисциплин (из внешней или локальной БД), список релевантных компетенций с их ИДК (из локальной БД) и существующие связи в матрице (из локальной БД).
*   **Аутентификация:** Требуется.
*   **Параметры пути:** `aup_num` (string)
*   **Статус:** ✅ **Проверен**

*   **Эндпоинт:** `POST /matrix/link`
*   **Описание:** Создает новую связь между дисциплиной (AupData из внешней/локальной БД) и индикатором (Indicator из локальной БД) в матрице.
*   **Аутентификация:** Требуется.
*   **Тело запроса (JSON):** `{ "aup_data_id": int, "indicator_id": int }`
*   **Успешные ответы:** `201 Created` (создана), `200 OK` (уже существует).
*   **Статус:** ✅ **Проверен**

*   **Эндпоинт:** `DELETE /matrix/link`
*   **Описание:** Удаляет связь между дисциплиной (AupData) и индикатором (Indicator) в матрице.
*   **Аутентификация:** Требуется.
*   **Тело запроса (JSON):** `{ "aup_data_id": int, "indicator_id": int }`
*   **Успешные ответы:** `200 OK` (удалена), `404 Not Found` (не найдена).
*   **Статус:** ✅ **Проверен**

### 5.4. Компетенции и Индикаторы

*   **Эндпоинт:** `GET /competencies`
*   **Описание:** Получает список всех компетенций из локальной БД.
*   **Аутентификация:** Требуется.
*   **Статус:** ✅ **Проверен**

*   **Эндпоинт:** `GET /competencies/<int:comp_id>`
*   **Описание:** Получает детальную информацию по одной компетенции с ее индикаторами.
*   **Аутентификация:** Требуется.
*   **Параметры пути:** `comp_id` (int)
*   **Статус:** ✅ **Проверен**

*   **Эндпоинт:** `POST /competencies`
*   **Описание:** Создает новую компетенцию в локальной БД.
*   **Аутентификация:** Требуется (Admin only).
*   **Тело запроса (JSON):** Объект компетенции (минимум: `type_code`, `code`, `name`).
*   **Статус:** ⚠️ **Требует проверки**

*   **Эндпоинт:** `PATCH /competencies/<int:comp_id>`
*   **Описание:** Обновляет существующую компетенцию по ID.
*   **Аутентификация:** Требуется (Admin only).
*   **Параметры пути:** `comp_id` (int)
*   **Тело запроса (JSON):** Объект с полями для обновления.
*   **Статус:** ❌ **Не реализован**

*   **Эндпоинт:** `DELETE /competencies/<int:comp_id>`
*   **Описание:** Удаляет компетенцию по ID.
*   **Аутентификация:** Требуется (Admin only).
*   **Параметры пути:** `comp_id` (int)
*   **Статус:** ❌ **Не реализован**

*   **Эндпоинт:** `GET /indicators`
*   **Описание:** Получает список всех индикаторов из локальной БД.
*   **Аутентификация:** Требуется.
*   **Статус:** ✅ **Проверен**

*   **Эндпоинт:** `GET /indicators/<int:ind_id>`
*   **Описание:** Получает детальную информацию по одному индикатору.
*   **Аутентификация:** Требуется.
*   **Параметры пути:** `ind_id` (int)
*   **Статус:** ✅ **Проверен**

*   **Эндпоинт:** `POST /indicators`
*   **Описание:** Создает новый индикатор для существующей компетенции в локальной БД.
*   **Аутентификация:** Требуется (Admin only).
*   **Тело запроса (JSON):** Объект индикатора (минимум: `competency_id`, `code`, `formulation`).
*   **Статус:** ⚠️ **Требует проверки**

*   **Эндпоинт:** `PATCH /indicators/<int:ind_id>`
*   **Описание:** Обновляет существующий индикатор по ID.
*   **Аутентификация:** Требуется (Admin only).
*   **Параметры пути:** `ind_id` (int)
*   **Тело запроса (JSON):** Объект с полями для обновления.
*   **Статус:** ❌ **Не реализован**

*   **Эндпоинт:** `DELETE /indicators/<int:ind_id>`
*   **Описание:** Удаляет индикатор по ID.
*   **Аутентификация:** Требуется (Admin only).
*   **Параметры пути:** `ind_id` (int)
*   **Статус:** ❌ **Не реализован**

### 5.5. ФГОС ВО

*   **Эндпоинт:** `GET /fgos`
*   **Описание:** Получает список всех сохраненных ФГОС ВО из локальной БД.
*   **Аутентификация:** Требуется.
*   **Статус:** ✅ **Проверен**

*   **Эндпоинт:** `GET /fgos/<int:fgos_id>`
*   **Описание:** Получает детальную информацию о ФГОС ВО по ID.
*   **Аутентификация:** Требуется.
*   **Параметры пути:** `fgos_id` (int)
*   **Статус:** ✅ **Проверен**

*   **Эндпоинт:** `POST /fgos/upload`
*   **Описание:** Загружает PDF файл ФГОС ВО для парсинга. Возвращает извлеченные данные без сохранения в БД.
*   **Аутентификация:** Требуется (Admin only).
*   **Тело запроса:** `multipart/form-data` с полем `file` (PDF).
*   **Статус:** ✅ **Проверен**

*   **Эндпоинт:** `POST /fgos/save`
*   **Описание:** Сохраняет ранее спарсенные данные ФГОС ВО в локальную БД.
*   **Аутентификация:** Требуется (Admin only).
*   **Тело запроса (JSON):** Объект с полями `parsed_data` (результат `/fgos/upload`), `filename`, и опционально `options` (`{"force_update": bool}`).
*   **Статус:** ✅ **Проверен**

*   **Эндпоинт:** `DELETE /fgos/<int:fgos_id>`
*   **Описание:** Удаляет ФГОС ВО по ID из локальной БД.
*   **Аутентификация:** Требуется (Admin only).
*   **Параметры пути:** `fgos_id` (int)
*   **Статус:** ✅ **Проверен**

### 5.6. Профессиональные Стандарты (ПС)

*   **Эндпоинт:** `GET /profstandards`
*   **Описание:** Получает список всех сохраненных Профессиональных стандартов из локальной БД.
*   **Аутентификация:** Требуется.
*   **Статус:** ✅ **Проверен**

*   **Эндпоинт:** `GET /profstandards/<int:ps_id>`
*   **Описание:** Получает детальную информацию о Профессиональном стандарте по ID.
*   **Аутентификация:** Требуется.
*   **Параметры пути:** `ps_id` (int)
*   **Статус:** ✅ **Проверен**

*   **Эндпоинт:** `POST /profstandards/upload`
*   **Описание:** Загружает файл Профессионального стандарта (HTML/DOCX/PDF), выполняет базовый парсинг и сохраняет основную информацию (код, имя, markdown) в локальную БД.
*   **Аутентификация:** Требуется (Admin only).
*   **Тело запроса:** `multipart/form-data` с полем `file`.
*   **Статус:** ⚠️ **Требует проверки**

*   **Эндпоинт:** `DELETE /profstandards/<int:ps_id>`
*   **Описание:** Удаляет Профессиональный стандарт по ID из локальной БД.
*   **Аутентификация:** Требуется (Admin only).
*   **Параметры пути:** `ps_id` (int)
*   **Статус:** ❌ **Не реализован**

### 5.7. Внешние Данные АУП

*   **Эндпоинт:** `GET /external/aups`
*   **Описание:** Получает список АУП из внешней базы данных KD с возможностью фильтрации и пагинации.
*   **Аутентификация:** Требуется.
*   **Параметры запроса (опционально):** `program_code`, `profile_num`, `profile_name`, `form_education_name`, `year_beg`, `degree_education_name`, `search_query`, `offset`, `limit`.
*   **Статус:** ✅ **Проверен**

*   **Эндпоинт:** `GET /external/aups/<int:aup_id>/disciplines`
*   **Описание:** Получает список записей дисциплин (AupData) для указанного ID АУП из внешней базы данных KD.
*   **Аутентификация:** Требуется.
*   **Параметры пути:** `aup_id` (int)
*   **Статус:** Требует проверки (Based on logic, seems implemented but not explicitly marked as checked)

---

Этот документ содержит ключевую информацию об API модуля `competencies_matrix`. Для полных схем данных и деталей реализации обратитесь к моделям и логике в коде (`maps_backend/competencies_matrix/models.py`, `maps_backend/competencies_matrix/logic.py`).

Некоторые связанные эндпоинты для управления АУП (например, CRUD для AupInfo) находятся в модуле `maps` (`/api/aup-info/<int:aup>`).