<!-- Нужно не только её исправить, но и в целом обновить информацию для программиста по проекту, с того момента (чекпоинта), как был сделан файл с описанием для программиста. Так как для ускорения процесса (не во вред общему пониманию работы системы, конечно же. Так называемый феномен "vibe coding" к хорошему не приведёт) я буду давать информацию для агентной LLM, ты можешь подойти к этому так, чтобы давать контекст агентной LLM, по всему, что она не сможет узнать при простом прочтении кодовой базы. Можно придумать это как взаимодействие между PM или PO и программистом, но они оба будут разговаривать на одном языке и понимать всё. Нужно объяснить много вещей, сделать это объяснение в виде To-Do листа или таски в таск-трекере (big picture, DoD, всё остальное), но нужно не стесняться давать детали и выдавать обширный план для всего. Точнее, не столько план, сколько общее видение, но на "языке машин". Я вас тоже пойму, всё равно. -->

Окей, обновляю `description.md` (руководство для разработчика), чтобы оно отражало *текущее* состояние кодовой базы модуля `competencies_matrix` и его интеграцию, **без** учета запланированных исправлений и доработок. Цель — дать точное описание для разработчика, подключающегося *сейчас*.

---

# Руководство для разработчика: Модуль `competencies_matrix` (Актуальное состояние)

**Версия документа:** 1.1
**Дата:** [Текущая дата]

## 1. Введение и Цель Модуля

Этот документ описывает модуль `competencies_matrix`, являющийся частью бэкенда веб-приложения "Карты Дисциплин" и расширяющий его функционал возможностями для работы с матрицами компетенций.

**Основная цель** модуля — предоставить инструменты для **создания, управления и визуализации матриц распределения компетенций для образовательных программ (ОП)** в соответствии с требованиями ФГОС ВО и Профессиональных Стандартов (ПС). Модуль фокусируется на работе с Компетенциями (УК, ОПК, ПК) и **Индикаторами их Достижения (ИДК)**.

**Ключевые задачи, решаемые модулем (в текущей реализации и ближайших планах):**

1.  **Хранение данных:** Обеспечение структуры БД для ОП, ФГОС, ПС, компетенций, ИДК и связей матрицы.
2.  **Управление ИДК и Компетенциями:** Предоставление базового API для создания и чтения компетенций и индикаторов.
3.  **Формирование Матрицы:** Реализация API для получения данных, необходимых для отображения матрицы (список дисциплин АУП, список ИДК, существующие связи), и для ручного управления связями "Дисциплина-ИДК".
4.  **Интеграция:** Взаимодействие с существующими данными модуля `maps` ("Карты Дисциплин") и использование общей системы аутентификации (`auth`).
5.  **Парсинг ПС:** Включение базовой логики для обработки файлов Профессиональных Стандартов.

Модуль является логически обособленной частью, но интегрирован в основной бэкенд.

## 2. Архитектурное Размещение

Модуль `competencies_matrix` реализован как **Flask Blueprint** (`competencies_matrix_bp`) с префиксом `/api/competencies`. Регистрация Blueprint происходит в основном файле приложения `app.py` внутри фабрики `create_app`. Файл `competencies_matrix/app_to_integrate.py` **не используется** для регистрации.

**Расположение в структуре проекта:**

```
maps_backend/
├── ... (другие модули: administration, auth, cabinet, maps) ...
├── competencies_matrix/   # <<<--- НАШ МОДУЛЬ
│   ├── __init__.py        # Регистрация Blueprint, настройка обработчиков ошибок
│   ├── routes.py          # API эндпоинты (GET /matrix/<aup_id>, POST/DELETE /matrix/link и т.д.)
│   ├── models.py          # SQLAlchemy модели для НОВЫХ таблиц (competencies_*)
│   ├── logic.py           # Функции бизнес-логики (get_matrix_for_aup, update_matrix_link и т.д.)
│   ├── parsers.py         # Логика парсинга ПС (адаптировано из profstandard-lean.py)
│   ├── schemas.py         # (Опц.) Схемы Pydantic/Marshmallow (пока не реализованы)
│   └── utils.py           # (Пока не используется активно)
├── ... (общие файлы: app.py, config.py, migrations) ...
```

Модуль использует **общую базу данных MySQL**, объект `db` и модели из `maps.models`, конфигурацию из `config.py` и модуль аутентификации `auth`.

## 3. Структура Модуля `competencies_matrix`

*   **`__init__.py`:** Создает `Blueprint`, задает префикс `/api/competencies`, регистрирует базовые обработчики ошибок 404/500 для этого Blueprint. Импортирует `routes.py`.
*   **`routes.py`:** Определяет API эндпоинты. Текущие реализованные эндпоинты включают:
    *   `GET /programs`: Получение списка ОП.
    *   `GET /programs/<program_id>`: Получение деталей ОП.
    *   `GET /matrix/<aup_id>`: Получение данных для построения матрицы АУП (**ключевой эндпоинт MVP**).
    *   `POST /matrix/link`: Создание связи Дисциплина-ИДК.
    *   `DELETE /matrix/link`: Удаление связи Дисциплина-ИДК.
    *   `POST /competencies`: Создание новой компетенции.
    *   `POST /indicators`: Создание нового индикатора.
    *   `POST /profstandards/upload`: Загрузка и базовый парсинг файла ПС.
    *   `GET /health-check`: Проверка доступности модуля.
    Все эндпоинты (кроме health-check) защищены декоратором `@login_required(request)` из модуля `auth`. Запросы **делегируются** функциям из `logic.py`.
*   **`models.py`:** Определяет SQLAlchemy модели для **новых таблиц**, специфичных для модуля (префикс `competencies_`). Эти модели **должны соответствовать** структуре, создаваемой миграцией Alembic `a388922067b4_correct_models_for_competencies_and_.py`. Ключевые модели: `FgosVo`, `EducationalProgram`, `ProfStandard`, `CompetencyType`, `Competency`, `Indicator`, `CompetencyMatrix`, а также ассоциативные таблицы и таблицы структуры ПС. Включает **динамическое добавление** `relationship` к модели `AupData` из `maps.models` для связи с матрицей.
*   **`logic.py`:** Содержит функции бизнес-логики, вызываемые из `routes.py`. Основные реализованные (или частично реализованные) функции:
    *   `get_educational_programs_list()`: Получает список ОП.
    *   `get_program_details()`: Получает детали ОП со связями.
    *   `get_matrix_for_aup()`: **Ключевая функция**, собирающая все данные для матрицы (инфо АУП, дисциплины, компетенции, ИДК, связи). Взаимодействует как с `competencies_matrix.models`, так и с `maps.models`.
    *   `update_matrix_link()`: Создает/удаляет записи в `CompetencyMatrix`.
    *   `create_competency()`, `create_indicator()`: Базовое добавление записей.
    *   `parse_prof_standard_file()`: Обрабатывает загруженный файл, вызывает парсер, сохраняет базовую информацию о ПС и Markdown.
*   **`parsers.py`:** Содержит логику парсинга ПС. Включает функции `detect_encoding`, `html_to_markdown_parser_enhanced` (основной парсер HTML в Markdown) и обертку `parse_uploaded_prof_standard`, вызываемую из `logic.py`. **Текущая реализация парсера** фокусируется на извлечении кода/имени ПС и генерации Markdown. Извлечение детальной структуры (ОТФ, ТФ и т.д.) является **задачей для дальнейшей доработки**.
*   **`schemas.py`, `utils.py`:** Пока не содержат значимой логики.

## 4. Ключевые Сущности и Поток Данных (Текущее Состояние)

Система оперирует сущностями, описанными в предыдущей версии документа (ОП, ФГОС, ПС, Компетенция, ИДК, АУП, AupData, Матрица).

**Текущий реализованный поток для отображения матрицы (`GET /matrix/<aup_id>`):**

1.  `routes.py` получает запрос с `aup_id`.
2.  Вызывается `logic.get_matrix_for_aup(aup_id)`.
3.  Функция запрашивает из БД (`db.session.query`):
    *   `AupInfo` (из `maps.models`) по `aup_id`.
    *   Связанную `EducationalProgram` и `FgosVo` (из `competencies_matrix.models`).
    *   Список `AupData` для `aup_id` (из `maps.models`).
    *   Список *всех* УК/ОПК и *всех* ПК с их индикаторами (из `competencies_matrix.models`) – **фильтрация по ОП/ФГОС для УК/ОПК и логика выборки ПК требуют доработки**.
    *   Существующие связи из `CompetencyMatrix`.
4.  `logic.py` форматирует полученные данные в структуру JSON, как описано в `routes.py` (ключи "aup_info", "disciplines", "competencies", "links", "suggestions").
5.  `routes.py` возвращает JSON клиенту.

## 5. Интеграция с Другими Модулями/Системами

*   **`maps`:** Активно **читает** данные `AupInfo`, `AupData`, `SprDiscipline`. Запись в `maps` не производится.
*   **`auth`:** Используется для защиты API (`@login_required`).
*   **`cabinet`:** **Нет** прямой интеграции на данный момент.
*   **ЛК:** Только через `auth` для аутентификации.
*   **NLP:** **Нет** интеграции на данный момент (функции возвращают пустые/заглушечные данные).

## 6. Управление Схемой и Данными

*   **Схема БД:** Определяется моделями в `*.models.py` (всех модулей) и управляется через **Alembic**. Актуальная структура должна соответствовать последней примененной миграции (включая `a388922067b4...py`).
*   **Создание/Обновление Схемы:** Выполняется **только** через `flask db upgrade`.
*   **Наполнение Данными:** Выполняется через команду `flask seed_db` (определена в `app.py`). **Текущая реализация `seed_db` требует доработки** для включения данных `competencies_*` и обеспечения идемпотентности (использования `db.session.merge()` или проверок).

## 7. Текущий Статус и Ближайшие Задачи (Фокус MVP)

*   **Статус:**
    *   Структура модуля создана.
    *   Миграция Alembic `a388922067b4...` существует и создает таблицы `competencies_*`.
    *   Модели в `competencies_matrix/models.py` определены, но **требуют финальной сверки** с миграцией.
    *   Реализованы базовые API эндпоинты в `routes.py`.
    *   Реализованы (частично или полностью) функции в `logic.py`, включая ключевую `get_matrix_for_aup`.
    *   Команда `seed_db` существует, но **не полна и не идемпотентна**.
    *   Парсер ПС существует, но извлекает в основном Markdown.
*   **Ближайшие Задачи (для завершения MVP):**
    1.  **Выверка моделей:** Финально сверить `competencies_matrix/models.py` с миграцией `a388922067b4...`.
    2.  **Доработка `seed_db`:** Сделать команду идемпотентной и добавить в нее тестовые данные для `competencies_*`, достаточные для проверки `GET /matrix/<aup_id>`.
    3.  **Доработка `logic.get_matrix_for_aup`:** Обеспечить корректную фильтрацию компетенций (хотя бы УК/ОПК по `fgos_vo_id`, если это поле будет добавлено) и связей. Отладить взаимодействие с моделями `maps`.
    4.  **Тестирование API:** Провести тестирование эндпоинта `GET /matrix/<aup_id>` с использованием `curl` и тестовых данных из `seed_db`.
    5.  **Реализация Frontend (параллельно):** Начать разработку UI для отображения матрицы на основе данных от `GET /matrix/<aup_id>`.

---

Этот документ дает представление о текущем состоянии модуля `competencies_matrix` и ближайших шагах для достижения MVP.