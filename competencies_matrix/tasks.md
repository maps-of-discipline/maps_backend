# Список Задач по Разработке Веб-приложения "Матрицы Компетенций"

**Проект:** Академический Прогресс / Карты Дисциплин (Бэкенд + Фронтенд)
**Компонент:** `competencies_matrix`
**Версия Документа:** 3.7
**Дата:** 2025-06-09

---

## Глоссарий Сокращений

*(Сохраняем глоссарий без изменений, он находится в файле structure.md)*

---

## 0. Приоритет и Цель MVP (Minimum Viable Product) - До Защиты

**Приоритет:** Создать **функциональный и понятный Frontend**, демонстрирующий основной **workflow просмотра и ручного редактирования** матрицы компетенций ("Дисциплина ↔ ИДК"), **просмотр справочников НСИ (ФГОС, ПС, Компетенции, Индикаторы)** и **ручного создания Профессиональных Компетенций (ПК) и Индикаторов их Достижения (ИПК) на основе данных из загруженных Профстандартов**, а также **импорт Индикаторов Универсальных Компетенций (ИУК) из распоряжений**.

**Источник данных:**
*   **Дисциплины АУП:** Получать из **внешней БД "Карты Дисциплин"** через API бэкенда (`/api/competencies/external/aups` и `/api/competencies/external/aups/<aup_id>/disciplines`).
*   **УК/ОПК/ИУК/ИОПК:** Из **локальной БД** модуля `competencies_matrix` (наполненной через `seed_db`, `import-fgos`, или **импорт из распоряжений**).
*   **Профессиональные Стандарты (ПС) и их структура (ОТФ, ТФ, ТД, НУ, НЗ):** Из **локальной БД** модуля `competencies_matrix` (наполненной **механизмом импорта из XML**).
*   **ПК/ИПК:** Из **локальной БД** модуля `competencies_matrix` (наполненной через `seed_db` + **ручной ввод через UI/API с использованием данных из загруженных ПС**).
*   **ФГОС (для просмотра):** Из **локальной БД** модуля `competencies_matrix` (наполненной через `seed_db` или `import-fgos`).
*   **Связи Матрицы:** Из **локальной БД** модуля `competencies_matrix`, управляемой через UI/API (`/api/competencies/matrix/link`).

**DoD для MVP (к защите):**

1.  **Бэкенд:**
    *   [x] Настроенный проект с актуальной схемой БД.
    *   [x] Рабочее подключение ко внешней БД КД.
    *   [x] API для поиска АУП из КД (`GET /external/aups`).
    *   [x] API для получения дисциплин АУП из КД (`GET /external/aups/<aup_id>/disciplines`).
    *   [x] API для получения данных матрицы (`GET /matrix/<aup_num>`), использующий дисциплины из КД.
    *   [x] API для ручного создания/удаления связей в матрице (`POST/DELETE /matrix/link`).
    *   [x] API для получения списка и деталей ФГОС (`GET /fgos`, `GET /fgos/<id>`).
    *   [x] API для загрузки, предпросмотра и сохранения ФГОС из PDF (`POST /fgos/upload`, `POST /fgos/save`, `DELETE /fgos/<id>`).
        *   [x] **(Backend): `models.py`: Добавлено `recommended_ps_parsed_data = db.Column(db.JSON, nullable=True)` в `FgosVo` для хранения сырых данных рекомендованных ПС из PDF.**
        *   [x] **(Backend): `logic.py`: Модифицирован `save_fgos_data`: после парсинга PDF сохраняет `parsed_data.get('recommended_ps', [])` в `fgos_vo.recommended_ps_parsed_data` как JSON-строку.**
        *   [x] **(Backend): `logic.py`: Модифицирован `get_fgos_details`:
            *   Десериализует `fgos.recommended_ps_parsed_data`.
            *   Для каждого ПС из десериализованных данных проверяет, существует ли он в БД.
            *   Формирует список `recommended_ps_list` для ответа, включающий для каждого ПС: `id`, `code`, `name` (из БД, если есть), `name_from_parsed_doc` (из `recommended_ps_parsed_data`), `is_loaded: boolean` (флаг, загружен ли ПС в БД).**
    *   --- **Импорт Профстандартов (ПС)** ---
    *   [x] **(Backend): `parsers.py`: Переработан для парсинга ПС из XML-файлов (поддержка всей структуры ОТФ, ТФ, ТД, НУ, НЗ).**
    *   [x] **(Backend): `logic.py`: Переработан `save_prof_standard_data` для сохранения полной структуры ПС (ОТФ, ТФ, ТД, НУ, НЗ).**
    *   [x] **(Backend): `routes.py`: Обновлен API `POST /profstandards/parse-preview` для приема XML-файлов и вызова нового парсера.**
    *   [x] **(Backend): `routes.py`: Обновлен API `POST /profstandards/save` для сохранения полной структуры ПС.**
    *   [x] API для получения списка ПС (`GET /profstandards`).
        *   [x] **(Backend): `logic.py`: Модифицирован `get_prof_standards_list`: для каждого `ProfStandard` получает список ФГОС, которые его рекомендуют (`recommended_by_fgos: [{ id: FgosVo.id, code: FgosVo.direction_code, name: FgosVo.direction_name, generation: FgosVo.generation }]`) через `fgos_assoc` (обратную связь). Возвращает плейсхолдеры для рекомендованных, но не загруженных ПС.**
    *   [x] API для получения деталей ПС (`GET /profstandards/<id>`), **включая полную структуру (ОТФ, ТФ, ТД, НУ, НЗ).**
    *   [x] **(Backend): `logic.py`: Оптимизирована скорость поиска в `search_prof_standards` за счет использования `FULLTEXT` индексов MySQL (`MATCH() AGAINST()`).**
    *   [x] **(Backend): `logic.py`: Реализована серверная фильтрация `search_prof_standards` по `qualification_levels` (уровням квалификации ОТФ) и `ps_ids` (выбранным ID ПС).**
    *   [x] **(Backend): `routes.py`: Добавлен новый эндпоинт `GET /profstandards/search` для выполнения оптимизированного поиска по ПС с фильтрами.**
    *   [x] **(Backend): `exports.py`: Добавлена новая функция `generate_tf_list_excel_export` для экспорта выбранных ТФ в Excel.**
    *   [x] **(Backend): `routes.py`: Добавлен новый эндпоинт `POST /profstandards/export-selected` для экспорта выбранных ТФ в Excel.**
    *   --- **Импорт Индикаторов УК из Распоряжений** ---
    *   [x] **(Backend): `models.py`: Добавлена модель `Disposition` для хранения метаданных распоряжений.**
    *   [x] **(Backend): `models.py`: В `Competency` добавлено `source_disposition_id` (FK на `Disposition`). `is_global_uk` и `FgosAppliesToCompetency` (M2M) пока НЕ реализованы (отложено).**
    *   [x] **(Backend): `nlp.py`: Добавлен новый промпт `_create_uk_indicators_disposition_prompt` для извлечения УК и ИУК из распоряжений.**
    *   [x] **(Backend): `nlp.py`: Добавлена новая функция `parse_uk_indicators_disposition_with_gemini` для парсинга распоряжений с помощью Gemini API.**
    *   [x] **(Backend): `logic.py`: Добавлена новая функция `process_uk_indicators_disposition_file` для оркестрации парсинга распоряжений, поиска применимых ФГОС (по уровню образования) и подготовки данных для сравнения (diff).**
    *   [x] **(Backend): `logic.py`: Добавлена новая функция `save_uk_indicators_from_disposition`, которая сохраняет/обновляет УК (с `source_disposition_id`) и их ИУК, привязывая каждую УК к **каждому** выбранному ФГОС ВО (текущая упрощенная логика).**
    *   [x] **(Backend): `routes.py`: Добавлены новые эндпоинты `POST /fgos/uk-indicators/upload` и `POST /fgos/uk-indicators/save` для работы с распоряжениями.**
    *   [x] API для получения списка всех Компетенций (`GET /competencies`) и Индикаторов (`GET /indicators`).
    *   [x] API для ручного создания ПК (`POST /competencies`). **Обновлен, позволяет связывать ПК с `LaborFunction` (ТФ из ПС) через `based_on_labor_function_id` и привязывать к `EducationalProgram` через `CompetencyEducationalProgram`.**
    *   [x] API для ручного создания ИПК (`POST /indicators`). **Обновлен, позволяет связывать ИПК с конкретными ТД/НУ/НЗ через `selected_ps_elements_ids` (JSON-поле в БД).**
    *   [x] API для ручного обновления ПК (`PATCH /competencies/<id>`). **Обновлен для изменения связей с ОПОП.**
    *   [x] API для ручного обновления ИПК (`PATCH /indicators/<id>`). **Обновлен для изменения `selected_ps_elements_ids`.**
    *   [x] API для ручного удаления ПК (`DELETE /competencies/<id>`).
    *   [x] API для ручного удаления ИПК (`DELETE /indicators/<id>`).
    *   [x] Команда `flask seed_db` для наполнения БД базовыми данными.
    *   [x] **(CLI): Обновлена команда `flask parse-profstandard <filepath>` для импорта XML ПС (использует новый парсер и логику).**
    *   [x] **(CLI): Создана новая команда `flask import-uk-indicators-disposition <filepath> --education-level <level>` для импорта распоряжений с ИУК.**

2.  **Фронтенд:**
    *   [x] Базовая структура модуля компетенций с навигацией по вкладкам (`CompetenciesView.vue`).
    *   [x] Вкладка "ОПОП" (`ProgramsView.vue`) с таблицей программ, деталями и возможностью перехода к матрице. **Добавлена колонка с основным АУП (`num_aup_primary`).**
    *   [x] Вкладка "Матрица компетенций" (`MatrixView.vue`).
    *   [x] UI для выбора АУП из внешней БД КД на вкладке "Матрица компетенций".
    *   [x] UI для отображения таблицы матрицы (`MatrixTable.vue`) с дисциплинами (из КД) x ИДК (из локальной БД). **Добавлены разделители семестров.**
    *   [x] UI для ручного управления связями (чекбоксы) в `MatrixTable.vue` и вызова API `POST/DELETE /matrix/link`. **Реализована индикация загрузки ссылки.**
    *   [x] Переключатель режима просмотра/редактирования матрицы (`ApEditMode.vue`).
    *   [x] Вкладка "ФГОС ВО" (`FgosView.vue`) со списком ФГОС, деталями и интерфейсом для загрузки/предпросмотра/сохранения из PDF.
        *   [x] **(Frontend): `FgosPreviewModal.vue`: Модифицировано отображение "Рекомендованных ПС":
            *   Показывает название (из БД, если есть), код, иконку "загружен" / "не загружен".
            *   Тултип для "не загружен" ПС.**
        *   [x] **(Frontend): `FgosView.vue`: Модифицирован `confirmDeleteFgos`:**
            *   **Добавлен 5-секундный таймер обратного отсчета** (кнопка "Удалить" изначально неактивна).
            *   **Предупреждение о каскадном удалении связанных УК/ОПК/ИУК/ИОПК (текст сообщения)**.
    *   --- **Страница Профстандартов и Формирования ПК/ИПК** ---
    *   [x] **(Frontend): Создана/Обновлена страница "Профстандарты" (`ProfStandardsView.vue`):**
        *   [x] Отображение списка загруженных ПС (коды, названия).
        *   [x] **Добавлена новая колонка "Рекомендация ФГОС"**:
            *   Отображает коды и названия ФГОС ВО, которые рекомендуют данный ПС (получать из `profStandard.recommended_by_fgos`).
            *   **Обеспечен перенос текста на 2-3 строки, если ширины не хватает.**
        *   [x] Интерфейс для загрузки нового ПС (XML-файл).
        *   [x] При выборе ПС из списка – отображение его **детальной структуры** (ОТФ → ТФ → ТД/НУ/НЗ) в удобном иерархическом виде (`ProfStandardDetailsModal.vue`).
        *   [x] **Поле поиска (`InputText`) и `MultiSelect` для уровней квалификации:** Инициируют открытие `ProfStandardSearchResultsModal.vue` для оптимизированного поиска.
        *   [x] **Кнопка "Открыть выбранные ПС":** Открывает `ProfStandardSearchResultsModal.vue`, показывая только ПС, предварительно выбранные в таблице.
    *   [x] **(Frontend): `ProfStandardSearchResultsModal.vue` (модальное окно поиска):**
        *   [x] **Виртуальный скроллинг** (`virtualScrollerOptions`) для быстрой отрисовки больших списков.
        *   [x] **Подсветка поискового запроса** в результатах (`HighlightText` компонент).
        *   [x] **Режимы отображения:** Переключатель "Все", "Найденное" (только элементы с совпадениями), "Выбранное" (только отмеченные вручную).
        *   [x] **Упрощенные чекбоксы:** Только один ручной чекбокс для выбора ТФ (без автоматических/"выбрать все").
        *   [x] **Независимый выбор ЗУН-элементов:** Чекбоксы для ТД/НУ/НЗ работают независимо от выбора ТФ.
        *   [x] **Кнопка "Экспорт в Excel"** для экспорта выбранных ТФ в Excel-файл.
    *   [x] **(Frontend): `CreateOrEditPKIPKFromPSModal.vue` (универсальное модальное окно создания/редактирования ПК/ИПК):**
        *   [x] Шаг 1: Формирование ПК (с предзаполнением из ТФ, привязкой к ОПОП, валидацией).
        *   [x] Шаг 2: Формирование ИПК (с выбором ТД/НУ/НЗ, предзаполнением формулировки, валидацией).
        *   [x] **Улучшенная генерация формулировок ПК и ИПК** (эвристика для глаголов, конкатенация ЗУН).
        *   [x] UI для редактирования существующих ПК и ИПК.
        *   [x] Сохранение `selected_ps_elements_ids` для ИПК.
    *   [x] Вкладка "Компетенции и Индикаторы" (`CompetenciesIndicatorsView.vue`) со списком всех компетенций и индикаторов.
        *   [x] Отображает ПК/ИПК, созданные новым способом, и их источник (ФГОС ВО, ПС, Ручной ввод).
        *   [x] Кнопки "Добавить ПК", "Добавить Индикатор" (для конкретной ПК).
        *   [x] Кнопки редактирования и удаления для ПК и ИПК.
    *   --- **Импорт Индикаторов УК из Распоряжений (Фронтенд)** ---
    *   [x] **(Frontend): `FgosView.vue`: Добавлен UI для загрузки PDF распоряжений (выбор уровня образования, кнопка "Загрузить Распоряжение").**
    *   [x] **(Frontend): Создано новое модальное окно `UkIndicatorsDispositionPreviewModal.vue`:**
        *   [x] Отображает метаданные распоряжения, список извлеченных УК и ИУК.
        *   [x] Показывает `applicable_fgos` (доступные ФГОС ВО в системе для указанного уровня образования) с чекбоксами для выбора, к каким ФГОС применить индикаторы.
        *   [x] **Визуализация `diff`:** Подсвечивает изменения в формулировках УК/ИУК по сравнению с существующими в БД (для каждого выбранного ФГОС).
        *   [x] Предоставляет чекбокс "Принудительно перезаписать..."
        *   [x] Кнопка "Сохранить" для отправки данных на бэкенд.
    *   [x] Адаптированы геттеры и экшены в `competenciesMatrix.ts` для работы со всеми новыми сущностями и их взаимодействиями.
    *   [x] Базовая обработка ошибок и статусов загрузки/сохранения в UI.

---

## 4. Задачи Backlog (После MVP / Для ВКР - в перспективе)

*   [ ] **Концептуальная Модель УК:** Переработать модель УК в БД (`Competency`) и связанную логику, чтобы УК были по-настоящему глобальными сущностями (одна запись для УК-1), а их применимость к конкретным ФГОС ВО (бакалавриат, специалитет, магистратура) управлялась через отдельную M2M-таблицу (`CompetencyAppliesToFgos`). Это решит проблему дублирования УК в БД, но потребует значительных изменений в логике `get_matrix_for_aup` и UI.
*   [ ] **Разрешение Конфликтов при Импорте:** Улучшить UI и логику `UkIndicatorsDispositionPreviewModal.vue` для более детального разрешения конфликтов (например, "Использовать новую/старую формулировку" для каждого ИУК/УК).
*   [ ] **NLP Интеграция:** Подключить NLP для более "умных" предложений формулировок ИПК (на основе ТД/НУ/НЗ) и для предложения ИУК/ИОПК на основе текстов УК/ОПК (если их нет в распоряжении).
*   [ ] **Связь ИПК с элементами ПС:** Реализовать сохранение и отображение явных связей между ИПК и конкретными ТД/НУ/НЗ в таблице `IndicatorPsLink`.
*   [ ] **Парсинг ОПК/ИОПК из ОПОП:** Реализовать парсинг ОПК/ИОПК из документов ОПОП (Таблица 4) и их сохранение/обновление в БД.
*   [ ] **Парсинг ПК/ИПК из ОПОП:** Реализовать парсинг ПК/ИПК из документов ОПОП (Таблица 5) и их сохранение/обновление в БД, с попыткой соотнесения с элементами ПС.
*   [ ] **Учет Успеваемости по ИДК:** Связать оценки с ИДК.
*   [ ] **Отчеты:** Генерация матрицы в DOCX и других отчетов.
*   [ ] **Локальное Кэширование/Синхронизация АУП.**
*   [ ] **Тестирование (Unit/Integration).**
*   [ ] **Документация API (более детальная).**
*   [ ] **Улучшение UI/UX.**